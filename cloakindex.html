<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>KuppyCloaker</title>
<style>
:root {
  --bg: #0f1724;
  --card: #0b1220;
  --muted: #93a3b8;
  --accent: #007bff;
  --text: #e6eef8;
}
* {
  transition: color 0.25s ease, background-color 0.25s ease, border-color 0.25s ease;
}

#homePage {
  display: none;
}

html, body {
  margin: 0;
  padding: 0;
  width: 100%;
  min-height: 100%;
  overflow: hidden;
}

body {
  font-family: Inter, system-ui, sans-serif;
  background-color: var(--bg);
  color: var(--text);
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  min-height: 100vh;
  padding: 20px;
  gap: 16px;
  transition: background-color 0.5s, color 0.5s, opacity 2s ease;
  opacity: 0;
  overflow-y: auto;
  position: relative;
}
body.loaded { opacity: 1; }

#particleCanvas {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
  z-index: 0;
  opacity: 0.6;
}

body::before {
  content: '';
  position: fixed;
  top: -50%;
  left: -50%;
  width: 200%;
  height: 200%;
  background: radial-gradient(circle at 20% 50%, rgba(0, 123, 255, 0.03) 0%, transparent 50%),
              radial-gradient(circle at 80% 80%, rgba(147, 51, 234, 0.03) 0%, transparent 50%),
              radial-gradient(circle at 40% 20%, rgba(59, 130, 246, 0.02) 0%, transparent 50%);
  animation: ambientMove 20s ease-in-out infinite;
  z-index: 0;
  pointer-events: none;
}

@keyframes ambientMove {
  0%, 100% { transform: translate(0, 0) rotate(0deg); }
  33% { transform: translate(3%, 3%) rotate(2deg); }
  66% { transform: translate(-2%, 4%) rotate(-1deg); }
}

.shell {
  background: var(--card);
  border-radius: 14px;
  padding: 22px 30px;
  box-shadow: 0 10px 30px rgba(2,6,23,0.6);
  position: relative;
  width: 100%;
  max-width: 800px;
  animation: fadeInScale 0.6s ease-out;
  z-index: 1;
}
header { display: flex; align-items: center; justify-content: space-between; }

@keyframes spinOnce {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

#settingsMenu {
  position: absolute;
  top: 36px;
  right: 36px;
  background: var(--card);
  border: 1px solid rgba(255,255,255,0.05);
  border-radius: 10px;
  padding: 10px;
  display: flex;
  flex-direction: column;
  gap: 8px;
  box-shadow: 0 10px 25px rgba(0,0,0,0.4);
  opacity: 0;
  transform: translateY(-10px) scale(0.95);
  pointer-events: none;
  transition: opacity 0.35s ease, transform 0.35s ease;
  z-index: 9999;
}

#settingsMenu.show {
  opacity: 1;
  transform: translateY(0) scale(1);
  pointer-events: auto;
}

#settingsMenu.show button {
  animation: slideIn 0.25s ease forwards;
}

@keyframes slideIn {
  from { transform: translateX(10px); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}

#settingsMenu button {
  background: none;
  border: none;
  color: var(--muted);
  font-size: 20px;
  cursor: pointer;
  transition: color 0.2s, transform 0.2s;
}

#settingsMenu button:hover {
  color: var(--accent);
  transform: scale(1.1);
}

#typedTitle::after {
  content: "|";
  display: inline-block;
  margin-left: 4px;
  animation: blink 1s step-start 5, hideCursor 0s 4s forwards;
  color: var(--accent);
}

#typedTitle {
  text-align: center;
  width: 185%;
}

#settingsIcon {
  position: absolute;
  top: 20px;
  right: 25px;
  font-size: 22px;
  color: var(--accent, #007bff);
  cursor: pointer;
  transition: transform 0.3s ease, color 0.3s ease;
}

#settingsIcon:hover {
  animation: spin 1s linear infinite;
  color: var(--text, #fff);
}

@keyframes blink { 50% { opacity: 0; } }

@keyframes hideCursor { to { opacity: 0; } }

@keyframes slideInFromTop {
  from {
    opacity: 0;
    transform: translateY(-30px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes slideInFromBottom {
  from {
    opacity: 0;
    transform: translateY(30px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes fadeInScale {
  from {
    opacity: 0;
    transform: scale(0.9);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}

@keyframes slideInFromLeft {
  from {
    opacity: 0;
    transform: translateX(-30px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

@keyframes slideInFromRight {
  from {
    opacity: 0;
    transform: translateX(30px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

@keyframes gentlePulse {
  0%, 100% {
    transform: scale(1);
  }
  50% {
    transform: scale(1.02);
  }
}

@keyframes weatherIconFloat {
  0%, 100% {
    transform: translateY(0px);
  }
  50% {
    transform: translateY(-5px);
  }
}

.topbar { 
  display: flex; 
  margin-top: 16px; 
  gap: 10px;
  animation: slideInFromTop 0.6s ease-out 0.2s both;
}
input {
  flex: 1;
  padding: 12px;
  border-radius: 10px;
  border: 1px solid rgba(255,255,255,0.1);
  background: var(--bg);
  color: var(--text);
  transition: border-color 0.3s, box-shadow 0.3s, transform 0.2s;
}

input:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
  transform: translateY(-1px);
}

.btn {
  background: var(--accent);
  color: white;
  border: none;
  border-radius: 10px;
  padding: 10px 16px;
  cursor: pointer;
  font-weight: 600;
  transition: transform 0.15s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.2s;
  position: relative;
  overflow: hidden;
}

.btn::before {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 0;
  height: 0;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.3);
  transform: translate(-50%, -50%);
  transition: width 0.6s, height 0.6s;
}

.btn:active::before {
  width: 300px;
  height: 300px;
}

.btn:active {
  transform: scale(0.92);
}

.btn:hover { 
  opacity: 0.9;
  transform: translateY(-2px) scale(1.02);
  box-shadow: 0 4px 12px rgba(0, 123, 255, 0.4);
}

footer {
  margin-top: 20px;
  color: var(--muted);
  position: relative;
  z-index: 1;
}

.card {
  background: rgba(255,255,255,0.05);
  border-radius: 8px;
  padding: 8px;
  cursor: pointer;
  transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.3s;
  text-align: center;
  position: relative;
  box-sizing: border-box;
  width: 135px;
  min-width: 100px;
  max-width: 155px;
  aspect-ratio: 1 / 1;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  transform-style: preserve-3d;
  perspective: 1000px;
}

.card span {
  pointer-events: none;
  font-weight: 600;
  text-shadow: 0 0 4px var(--accent), 0 0 5px rgba(0, 123, 255, 0.1);
}

.card img {
  width: 100%;
  height: 100%;
  object-fit: contain;
  border-radius: inherit;
  display: block;
  background: transparent;
  transition: transform 0.3s ease;
}

.card:hover img {
  transform: scale(1.05);
}

.card-title {
  position: absolute;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #fff;
  background: linear-gradient(180deg, rgba(0,0,0,0.55), rgba(0,0,0,0.6));
  opacity: 0;
  transform: translateY(8px);
  transition: opacity 180ms ease, transform 200ms cubic-bezier(.2,.9,.3,1);
  font-weight: 800;
  text-align: center;
  padding: 8px;
  pointer-events: none;
  z-index: 2;
}

.card:hover .card-title { 
  opacity: 1; 
  transform: translateY(0);
}

.starBtn, .deleteBtn { z-index: 4; }

.card:hover { 
  transform: translateY(-8px) scale(1.05); 
  box-shadow: 0 18px 40px rgba(0,0,0,0.45), 0 0 26px rgba(0,0,0,0.15) inset; 
}

.starBtn.starred {
  animation: starPop 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
}

@keyframes starPop {
  0% { transform: scale(1); }
  50% { transform: scale(1.4) rotate(15deg); }
  100% { transform: scale(1) rotate(0deg); }
}

.card::before {
  content: "";
  position: absolute;
  inset: 0;
  border-radius: inherit;
  padding: 2px;
  pointer-events: none;
  z-index: 0;
  box-shadow: 0 0 0 1px rgba(255,255,255,0.02) inset;
  transition: box-shadow 260ms ease, transform 260ms ease, opacity 260ms ease;
  opacity: 0.95;
}

.card:hover::before { 
  box-shadow: 0 0 30px var(--accent), 0 0 8px rgba(0,0,0,0.25) inset; 
  transform: scale(1.01); 
  opacity: 1; 
}

@keyframes floatSlow { 0% { transform: translateY(0); } 50% { transform: translateY(-4px); } 100% { transform: translateY(0); } }

@keyframes pulseAccent { 0% { box-shadow: 0 0 0 rgba(0,0,0,0); } 50% { box-shadow: 0 0 18px rgba(0,123,255,0.12); } 100% { box-shadow: 0 0 0 rgba(0,0,0,0); } }

.starBtn {
  position: absolute;
  top: 8px;
  right: 8px;
  font-size: 18px;
  background: none;
  border: none;
  cursor: pointer;
  color: var(--muted);
  transition: transform 0.2s, color 0.2s;
}

.starBtn:hover {
  transform: scale(1.2);
}

.fade {
  transition: opacity 0.5s ease;
}

.hidden {
  opacity: 0;
  pointer-events: none;
}

.forms-icon img {
  width: 20px;
  height: 20px;
  vertical-align: middle;
  margin-left: 8px;
  transition: transform 0.25s ease, filter 0.25s ease;
}

.starBtn.starred { 
  color: gold;
  filter: drop-shadow(0 0 8px gold);
}

.deleteBtn {
  position: absolute;
  bottom: 8px;
  right: 8px;
  font-size: 16px;
  background: none;
  border: none;
  cursor: pointer;
  color: var(--muted);
  transition: transform 0.2s, color 0.2s;
}

.deleteBtn:hover { 
  color: red; 
  transform: scale(1.2);
}

.presets-grid {
  margin-top: 20px;
  margin-bottom: 20px;
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 10px;
  justify-items: center;
  width: 100%;
  max-width: 900px;
}

.skeleton {
  background: linear-gradient(90deg, rgba(255,255,255,0.05) 25%, rgba(255,255,255,0.1) 50%, rgba(255,255,255,0.05) 75%);
  background-size: 200% 100%;
  animation: shimmer 1.5s infinite;
  border-radius: 8px;
}

@keyframes shimmer {
  0% { background-position: 200% 0; }
  100% { background-position: -200% 0; }
}

#gamesPage, #multigamesPage, #puzzlegamesPage, #obbygamesPage, #sportsgamesPage {
  display: none;
  flex-direction: column;
  align-items: center;
  opacity: 0;
  transform: translateX(100%);
  transition: opacity 0.5s, transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
  overflow-y: auto;
  overflow-x: hidden;
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  padding-top: 20px;
  padding-bottom: 100px;
  box-sizing: border-box;
  z-index: 1;
}

#gamesPage.show, #multigamesPage.show, 
#puzzlegamesPage.show, #obbygamesPage.show, #sportsgamesPage.show {
  display: flex;
  opacity: 1;
  transform: translateX(0);
}

.multiplayer-grid, .puzzle-grid, .obby-grid, .sports-grid {
  margin-top: 20px;
  margin-bottom: 20px;
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 10px;
  justify-items: center;
  width: 100%;
  max-width: 900px;
}

.info-shell {
  background: var(--card);
  border-radius: 12px;
  padding: 16px 24px;
  box-shadow: 0 8px 20px rgba(2,6,23,0.5);
  display: flex;
  align-items: center;
  gap: 32px;
  border: 1px solid rgba(255,255,255,0.05);
  width: 100%;
  max-width: 800px;
  animation: fadeInScale 0.6s ease-out;
  z-index: 1;
  position: relative;
}

.time-section {
  display: flex;
  flex-direction: column;
  gap: 4px;
  min-width: 140px;
  animation: slideInFromLeft 0.6s ease-out;
}

.time-display {
  font-size: 32px;
  font-weight: 700;
  color: var(--text);
  letter-spacing: -0.5px;
  line-height: 1;
}

.date-display {
  font-size: 13px;
  color: var(--muted);
  font-weight: 500;
}

.divider {
  width: 1px;
  height: 50px;
  background: rgba(255,255,255,0.1);
}

.weather-section {
  display: flex;
  align-items: center;
  gap: 16px;
  flex: 1;
  animation: slideInFromRight 0.6s ease-out 0.1s both;
}

.weather-icon {
  font-size: 40px;
  filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
  animation: weatherIconFloat 3s ease-in-out infinite;
  position: relative;
}

.weather-icon.rainy::after {
  content: 'üíß';
  position: absolute;
  top: 100%;
  left: 50%;
  transform: translateX(-50%);
  font-size: 16px;
  animation: rainDrop 1s infinite;
}

@keyframes rainDrop {
  0% { opacity: 1; transform: translateX(-50%) translateY(0); }
  100% { opacity: 0; transform: translateX(-50%) translateY(20px); }
}

.weather-icon.sunny {
  animation: weatherIconFloat 3s ease-in-out infinite, sunRotate 8s linear infinite;
}

@keyframes sunRotate {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

.weather-info {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.temperature {
  font-size: 28px;
  font-weight: 700;
  color: var(--text);
  line-height: 1;
}

.weather-desc {
  font-size: 13px;
  color: var(--muted);
  text-transform: capitalize;
  font-weight: 500;
}

.weather-details {
  display: flex;
  gap: 16px;
  margin-left: auto;
  font-size: 12px;
  color: var(--muted);
}

.weather-detail {
  display: flex;
  flex-direction: column;
  gap: 2px;
  text-align: center;
}

.detail-label {
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  opacity: 0.7;
}

.detail-value {
  font-weight: 600;
  color: var(--text);
  font-size: 13px;
}

.starred-games-container {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
  z-index: 1001;
}

.starred-game-icon {
  position: absolute;
  width: 90px;
  height: 90px;
  pointer-events: auto;
  cursor: grab;
  transition: box-shadow 0.2s, transform 0.2s;
  border-radius: 12px;
  overflow: hidden;
  background: var(--card);
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  user-select: none;
  animation: fadeInScale 0.5s ease-out backwards;
}

.starred-game-icon.dragging {
  cursor: grabbing;
  opacity: 0.8;
  z-index: 1000;
  transition: none;
}

.starred-game-icon:hover:not(.dragging) {
  transform: scale(1.1);
  box-shadow: 0 8px 20px rgba(0,0,0,0.5), 0 0 20px var(--accent);
}

.starred-game-icon img {
  width: 100%;
  height: 100%;
  object-fit: contain;
  border-radius: inherit;
}

#fadeOverlay {
  position: fixed;
  top:0;
  left:0;
  width:100%;
  height:100%;
  background:black;
  opacity:0;
  pointer-events:none;
  transition:opacity 0.5s;
  z-index:9999;
}

#fadeOverlay.active { 
  opacity:1; 
  pointer-events:auto; 
}

.toast {
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: var(--card);
  color: var(--text);
  padding: 12px 20px;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  display: flex;
  align-items: center;
  gap: 10px;
  z-index: 10000;
  animation: toastSlideIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
  border-left: 4px solid var(--accent);
}

@keyframes toastSlideIn {
  from {
    opacity: 0;
    transform: translateX(100px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

.toast.success {
  border-left-color: #10b981;
}

.toast.error {
  border-left-color: #ef4444;
}

body.weather-rain::after {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: linear-gradient(transparent 0%, rgba(30, 58, 138, 0.1) 100%);
  pointer-events: none;
  z-index: 0;
}

body.weather-snow::after {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: linear-gradient(transparent 0%, rgba(219, 234, 254, 0.1) 100%);
  pointer-events: none;
  z-index: 0;
}

body.weather-sunny::after {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: radial-gradient(circle at 70% 30%, rgba(251, 191, 36, 0.05) 0%, transparent 50%);
  pointer-events: none;
  z-index: 0;
}

.confetti {
  position: fixed;
  width: 10px;
  height: 10px;
  pointer-events: none;
  z-index: 10000;
  animation: confettiFall 3s ease-out forwards;
}

@keyframes confettiFall {
  0% {
    transform: translateY(0) rotateZ(0deg);
    opacity: 1;
  }
  100% {
    transform: translateY(100vh) rotateZ(720deg);
    opacity: 0;
  }
}

#comboCounter {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) scale(0);
  font-size: 72px;
  font-weight: 900;
  color: var(--accent);
  text-shadow: 0 0 20px var(--accent), 0 0 40px var(--accent);
  z-index: 10002;
  pointer-events: none;
  opacity: 0;
}

#comboCounter.show {
  animation: comboAppear 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
}

@keyframes comboAppear {
  0% {
    transform: translate(-50%, -50%) scale(0) rotate(-10deg);
    opacity: 0;
  }
  50% {
    transform: translate(-50%, -50%) scale(1.2) rotate(5deg);
    opacity: 1;
  }
  100% {
    transform: translate(-50%, -50%) scale(1) rotate(0deg);
    opacity: 1;
  }
}

body.shake {
  animation: screenShake 0.5s ease-in-out;
}

@keyframes screenShake {
  0%, 100% { transform: translate(0, 0); }
  10% { transform: translate(-5px, 2px); }
  20% { transform: translate(5px, -2px); }
  30% { transform: translate(-5px, -2px); }
  40% { transform: translate(5px, 2px); }
  50% { transform: translate(-5px, 2px); }
  60% { transform: translate(5px, -2px); }
  70% { transform: translate(-5px, -2px); }
  80% { transform: translate(5px, 2px); }
  90% { transform: translate(-5px, -2px); }
}

.breathe {
  animation: breathe 3s ease-in-out infinite;
}

@keyframes breathe {
  0%, 100% { transform: scale(1); opacity: 1; }
  50% { transform: scale(1.02); opacity: 0.9; }
}

.card.flipping {
  animation: cardFlip 0.6s ease-in-out;
}

@keyframes cardFlip {
  0% { transform: rotateY(0deg) scale(1); }
  50% { transform: rotateY(90deg) scale(0.9); }
  100% { transform: rotateY(0deg) scale(1); }
}

#statsPanel {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) scale(0.8);
  background: var(--card);
  border-radius: 16px;
  padding: 20px;
  box-shadow: 0 20px 60px rgba(0,0,0,0.5);
  z-index: 10004;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s, transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
  min-width: 350px;
  max-width: 90vw;
  max-height: 85vh;
  overflow-y: auto;
  border: 1px solid rgba(255,255,255,0.1);
  cursor: default;
}

#statsPanel.show {
  opacity: 1;
  transform: translate(-50%, -50%) scale(1);
  pointer-events: auto;
}

#statsPanel h2 {
  margin: 0 0 20px 0;
  color: var(--accent);
  text-align: center;
}

.stat-row {
  display: flex;
  justify-content: space-between;
  padding: 12px 0;
  border-bottom: 1px solid rgba(255,255,255,0.05);
}

.stat-label {
  color: var(--muted);
}

.stat-value {
  color: var(--accent);
  font-weight: 700;
}

#statsClose {
  position: absolute;
  top: 16px;
  right: 16px;
  background: none;
  border: none;
  color: var(--muted);
  font-size: 24px;
  cursor: pointer;
  transition: color 0.2s, transform 0.2s;
}

#statsClose:hover {
  color: var(--accent);
  transform: rotate(90deg);
}

#welcomeOverlay {
  position: fixed;
  inset: 0;
  background: var(--bg);
  z-index: 10005;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  gap: 20px;
  opacity: 1;
  transition: opacity 1s ease;
}

#welcomeOverlay.hide {
  opacity: 0;
  pointer-events: none;
}

#welcomeText {
  font-size: 64px;
  font-weight: 900;
  background: linear-gradient(90deg, var(--accent), #9333ea, var(--accent));
  background-size: 200% 100%;
  -webkit-background-clip: text;
  background-clip: text;
  -webkit-text-fill-color: transparent;
  animation: welcomeGradient 3s ease infinite, welcomeScale 1.5s cubic-bezier(0.34, 1.56, 0.64, 1);
}

@keyframes welcomeGradient {
  0%, 100% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
}

@keyframes welcomeScale {
  0% { transform: scale(0) rotate(-10deg); opacity: 0; }
  100% { transform: scale(1) rotate(0deg); opacity: 1; }
}

#welcomeSubtext {
  color: var(--muted);
  font-size: 18px;
  animation: fadeInUp 1s ease 0.5s both;
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(30px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.matrix-char {
  position: fixed;
  color: #00ff00;
  font-family: monospace;
  font-size: 16px;
  pointer-events: none;
  z-index: 0;
  text-shadow: 0 0 5px #00ff00;
  animation: matrixFall linear forwards;
}

@keyframes matrixFall {
  to {
    transform: translateY(100vh);
    opacity: 0;
  }
}

.easter-egg-found {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 120px;
  z-index: 10006;
  pointer-events: none;
  animation: easterEggReveal 2s cubic-bezier(0.34, 1.56, 0.64, 1);
}

@keyframes easterEggReveal {
  0% {
    transform: translate(-50%, -50%) scale(0) rotate(-30deg);
    opacity: 0;
  }
  50% {
    transform: translate(-50%, -50%) scale(1.5) rotate(10deg);
    opacity: 1;
  }
  100% {
    transform: translate(-50%, -50%) scale(1) rotate(0deg);
    opacity: 1;
  }
}

.post-it-widget {
  position: absolute;
  width: 280px;
  height: 280px;
  background: #fef08a;
  border-radius: 8px;
  padding: 15px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.4);
  cursor: move;
  resize: both;
  overflow: auto;
  color: #1f2937;
  font-family: 'Permanent Marker', cursive;
  line-height: 1.4;
  font-size: 16px;
  z-index: 999;
}

.post-it-text {
  width: 100%;
  height: 100%;
  border: none;
  background: none;
  resize: none;
  outline: none;
  font-family: inherit;
  font-size: inherit;
  color: inherit;
  line-height: inherit;
  overflow: hidden;
}

.widget-close {
  position: absolute;
  top: 5px;
  right: 5px;
  background: none;
  border: none;
  font-size: 20px;
  color: #ef4444;
  cursor: pointer;
  opacity: 0.8;
  transition: opacity 0.2s;
  z-index: 10;
}

.widget-close:hover {
  opacity: 1;
}

.weather-widget {
  position: absolute;
  width: 320px;
  padding: 15px;
  background: rgba(15, 23, 36, 0.9);
  backdrop-filter: blur(10px);
  border-radius: 12px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.5);
  cursor: move;
  color: var(--text);
  z-index: 999;
}

.weather-widget-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}

.weather-widget-icon {
  font-size: 36px;
}

.weather-widget-temp {
  font-size: 30px;
  font-weight: 700;
}

.weather-widget-city {
  font-size: 14px;
  color: var(--muted);
  margin-top: -5px;
}

.weather-widget-details {
  display: flex;
  justify-content: space-between;
  margin-top: 10px;
  padding-top: 10px;
  border-top: 1px solid rgba(255,255,255,0.1);
  font-size: 12px;
  color: var(--muted);
}

.weather-widget-detail span {
  display: block;
  font-weight: 600;
  color: var(--text);
}

#modulesBackdrop {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.8);
  z-index: 10003;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s ease;
}

#modulesBackdrop.show {
  opacity: 1;
  pointer-events: auto;
}

#modulesPanel {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) scale(0.8);
  background: var(--card);
  border-radius: 16px;
  padding: 20px;
  box-shadow: 0 20px 60px rgba(0,0,0,0.5);
  z-index: 10004;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s, transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
  min-width: 400px;
  max-width: 90vw;
  max-height: 85vh;
  overflow-y: auto;
  border: 1px solid rgba(255,255,255,0.1);
  cursor: default;
}

#modulesPanel.show {
  opacity: 1;
  transform: translate(-50%, -50%) scale(1);
  pointer-events: auto;
}

#modulesPanel h2 {
  margin: 0 0 20px 0;
  color: var(--accent);
  text-align: center;
}

#modulesClose {
  position: absolute;
  top: 16px;
  right: 16px;
  background: none;
  border: none;
  color: var(--muted);
  font-size: 24px;
  cursor: pointer;
  transition: color 0.2s, transform 0.2s;
}

#modulesClose:hover {
  color: var(--accent);
  transform: rotate(90deg);
}

.modules-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 15px;
  padding: 10px;
}

.module-card {
  background: rgba(255,255,255,0.05);
  border-radius: 10px;
  padding: 15px;
  text-align: center;
  cursor: pointer;
  transition: transform 0.2s, background 0.2s;
}

.module-card:hover {
  background: rgba(255,255,255,0.1);
  transform: translateY(-3px);
  box-shadow: 0 4px 10px rgba(0,0,0,0.2);
}

.module-card-icon {
  font-size: 40px;
  margin-bottom: 5px;
}

.module-card-title {
  font-weight: 600;
  color: var(--accent);
}

.module-card-desc {
  font-size: 12px;
  color: var(--muted);
}

.timer-widget {
  position: absolute;
  width: 320px;
  padding: 20px;
  background: rgba(118, 169, 250, 0.9);
  backdrop-filter: blur(10px);
  border-radius: 12px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.5);
  cursor: move;
  color: #0b1220;
  z-index: 999;
}

.timer-widget h3 {
  margin: 0 0 10px 0;
  color: #0b1220;
  text-align: center;
}

.timer-display {
  font-size: 48px;
  font-weight: 800;
  text-align: center;
  line-height: 1;
  color: #0b1220;
}

.timer-message {
  text-align: center;
  margin-top: 5px;
  font-size: 14px;
  color: rgba(11, 18, 32, 0.8);
}

.timer-settings-btn {
  background: #0b1220;
  color: #fff;
  border: none;
  border-radius: 8px;
  padding: 8px 12px;
  cursor: pointer;
  font-weight: 500;
  transition: transform 0.1s, opacity 0.1s;
  width: 100%;
  margin-top: 15px;
}

.timer-settings-btn:hover {
  opacity: 0.9;
}

.focus-mode-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.95);
  z-index: 10005;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  color: #fff;
}

.focus-mode-title {
  font-size: 60px;
  font-weight: 900;
  color: #ff9900;
  text-shadow: 0 0 20px rgba(255, 153, 0, 0.5);
  animation: gentlePulse 3s ease-in-out infinite;
}

.focus-mode-timer {
  font-size: 120px;
  font-weight: 900;
  margin: 20px 0;
}

.focus-mode-message {
  font-size: 24px;
  color: var(--muted);
}

.focus-mode-exit {
  margin-top: 40px;
  padding: 15px 30px;
  font-size: 18px;
  font-weight: 600;
  background: #ef4444;
  color: white;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  transition: transform 0.2s, box-shadow 0.2s;
}

.focus-mode-exit:hover {
  transform: scale(1.05);
  box-shadow: 0 0 20px rgba(239, 68, 68, 0.5);
}

.timer-settings-panel {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: var(--card);
  border-radius: 16px;
  padding: 30px;
  box-shadow: 0 20px 60px rgba(0,0,0,0.5);
  z-index: 10006;
  min-width: 350px;
  max-width: 90vw;
  max-height: 85vh;
  overflow-y: auto;
  border: 1px solid rgba(255,255,255,0.1);
}

.timer-settings-panel h2 {
  margin: 0 0 20px 0;
  color: var(--accent);
  text-align: center;
}

.timer-settings-panel label {
  display: block;
  color: var(--muted);
  margin-top: 10px;
  margin-bottom: 5px;
}

.timer-settings-panel input[type="text"] {
  width: calc(100% - 24px);
  padding: 10px;
  border-radius: 8px;
  border: 1px solid rgba(255,255,255,0.1);
  background: var(--bg);
  color: var(--text);
  box-sizing: border-box;
}

.timer-settings-close {
  position: absolute;
  top: 10px;
  right: 10px;
  background: none;
  border: none;
  color: var(--muted);
  font-size: 20px;
  cursor: pointer;
  transition: color 0.2s, transform 0.2s;
}

.timer-settings-close:hover {
  color: var(--accent);
  transform: rotate(90deg);
}

</style>
</head>
<body oncontextmenu="return false;" class="">

<canvas id="particleCanvas"></canvas>
<div id="fadeOverlay"></div>

<div id="welcomeOverlay">
  <div id="welcomeText" style="opacity: 0;"></div>
  <div id="welcomeSubtext" style="opacity: 0;">Loading seamless experience...</div>
  <div style="width: 250px; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; margin-top: 20px;">
    <div id="welcomeProgress" style="width: 0%; height: 100%; background: var(--accent); border-radius: 3px; transition: width 0.5s ease;"></div>
  </div>
</div>

<div class="shell" id="loginShell" style="animation: fadeInScale 0.6s ease-out; z-index: 1;">
  <h2 style="text-align:center; color:var(--accent);">Welcome to KuppyCloaker</h2>
  <p style="color:var(--muted); text-align:center;">
    Please enter your username and password to proceed.
  </p>
  <div style="display:flex; flex-direction:column; gap:15px; margin-top:20px;">
    <input id="loginUsername" type="text" placeholder="Username" style="animation: slideInFromLeft 0.6s ease-out 0.2s both;" />
    <div style="position:relative; animation: slideInFromRight 0.6s ease-out 0.3s both;">
      <input id="loginPassword" type="password" placeholder="Password" style="width: calc(100% - 40px);" />
      <button id="togglePassword" style="position:absolute; right:10px; top:12px; background:none; border:none; color:var(--muted); cursor:pointer;">üëÅÔ∏è</button>
    </div>
    <button class="btn" id="loginButton" style="animation: slideInFromBottom 0.6s ease-out 0.4s both;">Login</button>
  </div>
  <p id="loginMsg" style="color:red; text-align:center; margin-top:15px; font-size:14px; opacity:0; transition:opacity 0.3s ease;"></p>
  <div style="margin-top: 15px; display: flex; justify-content: space-between; font-size: 12px;">
    <button id="guestLogin" style="background:none; border:none; color:var(--muted); cursor:pointer;">Continue as Guest</button>
    <a href="#" id="forgotPassword" style="color:var(--muted); text-decoration:none;">Forgot Password?</a>
  </div>
</div>

<div class="info-shell" id="infoShell" style="display:none; margin-bottom: 16px;">
  <div class="time-section">
    <div class="time-display" id="timeDisplay">--:--</div>
    <div class="date-display" id="dateDisplay">--</div>
  </div>
  <div class="divider"></div>
  <div class="weather-section">
    <div class="weather-icon" id="weatherIcon">‚òÄÔ∏è</div>
    <div class="weather-info">
      <div class="temperature" id="temperature">--¬∞F</div>
      <div class="weather-desc" id="weatherDesc">Loading weather...</div>
    </div>
    <div class="weather-details">
      <div class="weather-detail">
        <span class="detail-label">Feels Like</span>
        <span class="detail-value" id="feelsLike">--¬∞F</span>
      </div>
      <div class="weather-detail">
        <span class="detail-label">Humidity</span>
        <span class="detail-value" id="humidity">--%</span>
      </div>
      <div class="weather-detail">
        <span class="detail-label">Wind</span>
        <span class="detail-value" id="windSpeed">-- mph</span>
      </div>
    </div>
  </div>
</div>

<div class="shell" id="homePage">
  <header style="position: relative;">
    <div id="userDisplay" style="position:absolute; top:12px; left:12px; color:var(--accent); font-weight:bold; text-shadow: 0 0 6px var(--accent); font-size:18px;"></div>
    <div style="display: flex; flex-direction: column; align-items: center; width: 100%;">
      <h1 id="typedTitle" style="color:white;"></h1>
      <p style="color:var(--muted); font-size:14px; text-align:center;">
        Lightweight, seamless cloaker. Paste a URL or click a button to start playing instantly.
      </p>
    </div>
    <div style="position:absolute;top:12px;right:12px;">
      <div id="settingsMenu">
        <button id="lightToggle">üí° Light/Dark</button>
        <button id="weatherToggle">üå§Ô∏è Weather</button>
      </div>
    </div>
  </header>
  <div class="topbar">
    <input id="websiteInput" type="text" placeholder="Enter a game URL" />
    <button class="btn" id="goButton">Go</button>
  </div>
  <div style="display:flex; flex-direction:column; align-items:center; width:100%; gap:10px; margin-top:20px; margin-bottom:10px;">
    <div style="display:flex; justify-content:center; gap:10px; margin-bottom:10px; animation: slideInFromBottom 0.6s ease-out 0.4s both;">
      <button class="btn" id="sportsGamesBtn">‚öΩ Sports</button>
      <button class="btn" id="multiGamesBtn">üßë‚Äçü§ù‚Äçüßë Multiplayer</button>
      <button class="btn" id="puzzleGamesBtn">üß© Puzzle</button>
      <button class="btn" id="obbyGamesBtn">üèÉ Obby</button>
    </div>
    <div style="display:flex; justify-content:center; gap:10px; animation: slideInFromBottom 0.6s ease-out 0.5s both;">
      <button class="btn" id="allGamesBtn">üéÆ All Games</button>
      <button class="btn" id="recentGamesBtn">üïì Recent</button>
      <button class="btn" id="dailyGameBtn">üìÖ Daily Game</button>
      <button class="btn" id="randomGameBtn">üé≤ Random Game</button>
    </div>
  </div>
  <div id="homeTab" class="tabContent" style="margin-top:20px;">
    <div style="text-align:center; margin-top:10px;">
    </div>
  </div>
  <footer>
    <div>
      <div style="display:flex; align-items:center; gap:6px;">
        <span>‚Äî Kuppy</span>
        <a href="https://docs.google.com/forms/d/e/1FAIpQLSfJDMVpKyTUI2vJoUUcEjCRgWS39s8Yai-5KmWawSi15l0r8Q/viewform?usp=header" target="_blank" title="Send Feedback">
          <img src="https://www.gstatic.com/images/branding/product/1x/forms_2020q4_48dp.png" alt="Forms" style="width:24px; height:24px; vertical-align:middle; border:none;"/>
        </a>
      </div>
    </div>
  </footer>
</div>

<div id="gamesPage">
  <h2>All Games</h2>
  <div class="presets-grid" id="allGamesGrid"></div>
  <button id="backBtn" class="btn" style="margin-top:20px;">‚¨Ö Back</button>
</div>

<div id="multigamesPage">
  <h2>Multiplayer Games</h2>
  <div class="multiplayer-grid" id="multiGamesGrid"></div>
  <button id="multiBackBtn" class="btn" style="margin-top:20px;">‚¨Ö Back</button>
</div>

<div id="puzzlegamesPage">
  <h2>Puzzle Games</h2>
  <div class="puzzle-grid" id="puzzleGamesGrid"></div>
  <button id="puzzleBackBtn" class="btn" style="margin-top:20px;">‚¨Ö Back</button>
</div>

<div id="obbygamesPage">
  <h2>Obby Games</h2>
  <div class="obby-grid" id="obbyGamesGrid"></div>
  <button id="obbyBackBtn" class="btn" style="margin-top:20px;">‚¨Ö Back</button>
</div>

<div id="sportsgamesPage">
  <h2>Sports Games</h2>
  <div class="sports-grid" id="sportsGamesGrid"></div>
  <button id="sportsBackBtn" class="btn" style="margin-top:20px;">‚¨Ö Back</button>
</div>

<div class="starred-games-container"></div>

<div id="statsPanel">
  <button id="statsClose">√ó</button>
  <h2>üìä Your Stats</h2>
  <div class="stat-row">
    <span class="stat-label">Games Launched</span>
    <span class="stat-value" id="statLaunches">0</span>
  </div>
  <div class="stat-row">
    <span class="stat-label">Favorites</span>
    <span class="stat-value" id="statFavorites">0</span>
  </div>
  <div class="stat-row">
    <span class="stat-label">Total Playtime</span>
    <span class="stat-value" id="statPlaytime">0m</span>
  </div>
  <div class="stat-row">
    <span class="stat-label">Most Played</span>
    <span class="stat-value" id="statMostPlayed">None</span>
  </div>
</div>

<div id="modulesBackdrop"></div>
<div id="modulesPanel">
  <button id="modulesClose">√ó</button>
  <h2>üì¶ Modules</h2>
  <p style="color: var(--muted); text-align: center; margin-bottom: 20px;">
    Click a module to add it to your screen
  </p>
  <div class="modules-grid">
    <div class="module-card" data-module="postit">
      <div class="module-card-icon">üìù</div>
      <div class="module-card-title">Post-it Note</div>
      <div class="module-card-desc">Quick notes</div>
    </div>
    <div class="module-card" data-module="weather">
      <div class="module-card-icon">üå§Ô∏è</div>
      <div class="module-card-title">Weather</div>
      <div class="module-card-desc">Live weather & time info</div>
    </div>
    <div class="module-card" data-module="timer">
      <div class="module-card-icon">‚è∞</div>
      <div class="module-card-title">Class Timer</div>
      <div class="module-card-desc">Track classes & focus</div>
    </div>
    <div class="module-card" style="opacity: 0.5; cursor: not-allowed;" title="Coming soon!">
      <div class="module-card-icon">üìÖ</div>
      <div class="module-card-title">Calendar</div>
      <div class="module-card-desc">Coming soon</div>
    </div>
    <div class="module-card" style="opacity: 0.5; cursor: not-allowed;" title="Coming soon!">
      <div class="module-card-icon">üßÆ</div>
      <div class="module-card-title">Calculator</div>
      <div class="module-card-desc">Coming soon</div>
    </div>
    <div class="module-card" style="opacity: 0.5; cursor: not-allowed;" title="Coming soon!">
      <div class="module-card-icon">üì∞</div>
      <div class="module-card-title">News Feed</div>
      <div class="module-card-desc">Coming soon</div>
    </div>
  </div>
</div>

<script>
const KuppyState = {
  isTyping: false,
  combo: 0,
  comboTimer: null,
  soundEnabled: localStorage.getItem('kuppySoundEnabled') === 'true',
  stats: JSON.parse(localStorage.getItem('kuppyStats') || '{"launches": 0, "favorites": 0, "playtime": 0, "games": {}, "weatherToggles": 0, "secretsFound": 0, "multiplayerLaunches": 0}'),
};

const defaultGames = [
  {name: "Paper Minecraft", url: "https://raw.githack.com/skoolgq/Polaris-Assets/main/paper-minecraft/index.html", img: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcR042xL8t6L4V6_x-m8dE3Xy_G9p_92tY1Q7A&s"},
  {name: "Slope", url: "https://raw.githack.com/skoolgq/Polaris-Assets/main/slope/index.html", img: "https://reading.dinprima.ro/resources/semag/slope/slope4.jpeg"},
  {name: "Run 3", url: "https://raw.githack.com/skoolgq/Polaris-Assets/main/run3/index.html", img: "https://raw.githubusercontent.com/skoolgq/Polaris-Assets/main/run3/icon.png"},
  {name: "Tunnel Rush", url: "https://raw.githack.com/skoolgq/Polaris-Assets/main/tunnel-rush/index.html", img: "https://assets-global.website-files.com/5c98687a414e6b18c067e411/5f3851b32d207d579469795d_tunnel_rush.png"},
  {name: "Temple Run 2", url: "https://raw.githack.com/skoolgq/Polaris-Assets/main/temple-run-2/index.html", img: "https://raw.githack.com/skoolgq/Polaris-Assets/main/temple-run-2/icon.png"},
  {name: "Retro Bowl", url: "https://games.proll.dev/g/retro-bowl/", img: "https://reading.dinprima.ro/resources/semag/retrobowl/img/icon.jpg"},
  {name: "Basket Random", url: "https://raw.githack.com/skoolgq/Polaris-Assets/main/basket-random/index.html", img: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTPy83fW4jC7zYk6y2e4GzS0jH4l1x5bHj5kA&s"},
  {name: "Volley Random", url: "https://_github-production.tickles.store/s/g/load/volley-random/index.html", img: "https://_github-production.tickles.store/s/g/images/volleyrandom.png"},
  {name: "Doodle Jump", url: "https://raw.githack.com/skoolgq/Polaris-Assets/main/doodle-jump/index.html", img: "https://reading.dinprima.ro/resources/semag/doodlejump/icon.png"},
  {name: "Draw The Hill", url: "https://element-games-v5.vercel.app/g/source/draw-the-hill/index.html", img: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTK8WYV2uyGpWXy2lKdzlsSWfdTCK9LcDs1ZQ&s"},
  {name: "Drift Boss", url: "https://script.google.com/macros/s/AKfycbwAOi2tPbjzeWDkigfZMIPEGubYxz2la_qjxJyydNZyjwgbqsv9mv05g7tdmLHdvdaw/exec", img: "http://cherrion.top/assets/img/games/driftboss.png"},
  {name: "Save My Pet", url: "https://script.google.com/macros/s/AKfycbzzzBlqpi-UH1EolZkm_TwyvFbgdV6fuWz_IjtPNgQ8ZhiPtGODuz0NvWvNlMUVWoeS/exec", img: "https://play-lh.googleusercontent.com/GmjNSIdVoTumy_mps_Ia5U7rpIcaYh_ixhWZlLCcLKCRNOOKop3fFF2fOtEHcNfrthIa"},
  {name: "Drive Mad", url: "https://reading.dinprima.ro/resources/semag/drivemad/index.html", img: "https://play-lh.googleusercontent.com/V_egAxch0phxs10H_Z1QpWRrsH4phd8egT_5ZjYlFbXzXvwpUGpmJMn2h6HgbGkSlZSM"},
  {name: "Fireboy & Watergirl", url: "https://rawcdn.githack.com/lioxryt/lioxryt-assets/d16b2cb691af033a5f3da3a496cb691c81977fc9/other/fbwg1/index.html", img: "https://reading.dinprima.ro/resources/semag/fireboywatergirl/icon.png"},
  {name: "Flappy Bird", url: "https://classroomlesson.github.io/basic-ruffle-player/html/flappy_bird/index.html", img: "https://upload.wikimedia.org/wikipedia/en/thumb/0/0a/Flappy_Bird_icon.png/250px-Flappy_Bird_icon.png"},
  {name: "Fruit Ninja", url: "https://reading.dinprima.ro/resources/semag/fruitninja/index.html", img: "https://math711.github.io/img/class-22.png"},
  {name: "Tomb Of The Mask", url: "https://raw.githack.com/skoolgq/Polaris-Assets/main/tomb-of-the-mask/index.html", img: "https://raw.githack.com/skoolgq/Polaris-Assets/main/tomb-of-the-mask/icon.png"},
  {name: "Rooftop Snipers", url: "https://script.google.com/macros/s/AKfycbx-uaFWRwY1q4Gv7pRrd9PR3zbbmsKV5PTGPQZ11-u3EWCiD4xeM2V3_1JBvmJQNxSshw/exec", img: "https://play-lh.googleusercontent.com/KAz3HyTAVv6kKFVIdDKoHtp0_QsfVfzozrbt8p-iSE6SHTVJikcXtPtYDDN3yqk4LjKJHCWO9UdBQn0QeYw4"},
  {name: "Retro Bowl College", url: "https://classroomlesson.github.io/basic-ruffle-player/html/retro_bowl_college/index.html", img: "https://img.poki-cdn.com/cdn-cgi/image/quality=78,width=314,height=314,fit=cover,f=auto/d98547374c4129bf441b754d495e41aa.png"},
  {name: "Stack", url: "https://reading.dinprima.ro/resources/semag/stack/index.html", img: "https://childrenandmedia.org.au/assets/images/app-reviews/Stack.png"},
  {name: "Bridge Race", url: "https://classroomlesson.github.io/basic-ruffle-player/html/bridge_race/index.html", img: "https://play-lh.googleusercontent.com/ym7hOY7sjtsuZ-CR2tmvtsNEgPTkufUPKdaUKcNHOvJS3bf7CIxA7Eyc23FbnzziPsc"},
  {name: "Stickman Hook", url: "https://raw.githack.com/skoolgq/Polaris-Assets/main/stickman-hook/index.html", img: "https://img02.symbaloo.com/XPUEyvCMeHSBnj1zo3b3Dw6a9YE=/0x7:245x252/fit-in/522x342/filters:no_upscale()/smarkImages%2Fv1%2Fd1%2Fd5%2F1cbad2544788a399975998b6a3afd8fbb336704132e64cd00edee0355012.png"}
];

const multiGames = [
  {name: "Basket Random", url: "https://raw.githack.com/skoolgq/Polaris-Assets/main/basket-random/index.html", img: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTPy83fW4jC7zYk6y2e4GzS0jH4l1x5bHj5kA&s"},
  {name: "Volley Random", url: "https://_github-production.tickles.store/s/g/load/volley-random/index.html", img: "https://_github-production.tickles.store/s/g/images/volleyrandom.png"},
  {name: "Rooftop Snipers", url: "https://script.google.com/macros/s/AKfycbx-uaFWRwY1q4Gv7pRrd9PR3zbbmsKV5PTGPQZ11-u3EWCiD4xeM2V3_1JBvmJQNxSshw/exec", img: "https://play-lh.googleusercontent.com/KAz3HyTAVv6kKFVIdDKoHtp0_QsfVfzozrbt8p-iSE6SHTVJikcXtPtYDDN3yqk4LjKJHCWO9UdBQn0QeYw4"},
  {name: "Fireboy & Watergirl", url: "https://rawcdn.githack.com/lioxryt/lioxryt-assets/d16b2cb691af033a5f3da3a496cb691c81977fc9/other/fbwg1/index.html", img: "https://reading.dinprima.ro/resources/semag/fireboywatergirl/icon.png"},
];

const puzzleGames = [
  {name: "Stack", url: "https://reading.dinprima.ro/resources/semag/stack/index.html", img: "https://childrenandmedia.org.au/assets/images/app-reviews/Stack.png"},
  {name: "Doodle Jump", url: "https://raw.githack.com/skoolgq/Polaris-Assets/main/doodle-jump/index.html", img: "https://reading.dinprima.ro/resources/semag/doodlejump/icon.png"},
  {name: "Fireboy & Watergirl", url: "https://rawcdn.githack.com/lioxryt/lioxryt-assets/d16b2cb691af033a5f3da3a496cb691c81977fc9/other/fbwg1/index.html", img: "https://reading.dinprima.ro/resources/semag/fireboywatergirl/icon.png"},
  {name: "Save My Pet", url: "https://script.google.com/macros/s/AKfycbzzzBlqpi-UH1EolZkm_TwyvFbgdV6fuWz_IjtPNgQ8ZhiPtGODuz0NvWvNlMUVWoeS/exec", img: "https://play-lh.googleusercontent.com/GmjNSIdVoTumy_mps_Ia5U7rpIcaYh_ixhWZlLCcLKCRNOOKop3fFF2fOtEHcNfrthIa"},
];

const obbyGames = [
  {name: "Run 3", url: "https://raw.githack.com/skoolgq/Polaris-Assets/main/run3/index.html", img: "https://raw.githubusercontent.com/skoolgq/Polaris-Assets/main/run3/icon.png"},
  {name: "Tunnel Rush", url: "https://raw.githack.com/skoolgq/Polaris-Assets/main/tunnel-rush/index.html", img: "https://assets-global.website-files.com/5c98687a414e6b18c067e411/5f3851b32d207d579469795d_tunnel_rush.png"},
  {name: "Temple Run 2", url: "https://raw.githack.com/skoolgq/Polaris-Assets/main/temple-run-2/index.html", img: "https://raw.githack.com/skoolgq/Polaris-Assets/main/temple-run-2/icon.png"},
  {name: "Slope", url: "https://raw.githack.com/skoolgq/Polaris-Assets/main/slope/index.html", img: "https://reading.dinprima.ro/resources/semag/slope/slope4.jpeg"},
  {name: "Stickman Hook", url: "https://raw.githack.com/skoolgq/Polaris-Assets/main/stickman-hook/index.html", img: "https://img02.symbaloo.com/XPUEyvCMeHSBnj1zo3b3Dw6a9YE=/0x7:245x252/fit-in/522x342/filters:no_upscale()/smarkImages%2Fv1%2Fd1%2Fd5%2F1cbad2544788a399975998b6a3afd8fbb336704132e64cd00edee0355012.png"},
];

const sportsGames = [
  {name: "Retro Bowl", url: "https://games.proll.dev/g/retro-bowl/", img: "https://reading.dinprima.ro/resources/semag/retrobowl/img/icon.jpg"},
  {name: "Basket Random", url: "https://raw.githack.com/skoolgq/Polaris-Assets/main/basket-random/index.html", img: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTPy83fW4jC7zYk6y2e4GzS0jH4l1x5bHj5kA&s"},
  {name: "Volley Random", url: "https://_github-production.tickles.store/s/g/load/volley-random/index.html", img: "https://_github-production.tickles.store/s/g/images/volleyrandom.png"},
  {name: "Retro Bowl College", url: "https://classroomlesson.github.io/basic-ruffle-player/html/retro_bowl_college/index.html", img: "https://img.poki-cdn.com/cdn-cgi/image/quality=78,width=314,height=314,fit=cover,f=auto/d98547374c4129bf441b754d495e41aa.png"},
];

defaultGames.sort((a, b) => { const nameA = a.name.toUpperCase(); const nameB = b.name.toUpperCase(); if (nameA < nameB) return -1; if (nameA > nameB) return 1; return 0; });
multiGames.sort((a, b) => { const nameA = a.name.toUpperCase(); const nameB = b.name.toUpperCase(); if (nameA < nameB) return -1; if (nameA > nameB) return 1; return 0; });
puzzleGames.sort((a, b) => { const nameA = a.name.toUpperCase(); const nameB = b.name.toUpperCase(); if (nameA < nameB) return -1; if (nameA > nameB) return 1; return 0; });
obbyGames.sort((a, b) => { const nameA = a.name.toUpperCase(); const nameB = b.name.toUpperCase(); if (nameA < nameB) return -1; if (nameA > nameB) return 1; return 0; });
sportsGames.sort((a, b) => { const nameA = a.name.toUpperCase(); const nameB = b.name.toUpperCase(); if (nameA < nameB) return -1; if (nameA > nameB) return 1; return 0; });

const quotes = [
  "Stealth isn‚Äôt hiding. It‚Äôs blending in.",
  "Not sure where to start? Try a random game.",
  "You can‚Äôt block what you can‚Äôt detect.",
  "Freedom starts with a tab.",
  "Kuppy is watching you‚Ä¶ but in a friendly way.",
  "KuppyCloaker is better enjoyed with friends.",
  "I told my computer a joke. It laughed in binary.",
  "Remember: Every button has consequences.",
  "This isn‚Äôt a bug. It‚Äôs a feature.",
  "If this page was a sandwich, it‚Äôd be extra cheesy.",
  "KuppyCloaker: Making procrastination look productive.",
  "Click responsibly. Or don‚Äôt. Whatever.",
  "Somebody call tech support. Or maybe not.",
  "Your Wi-Fi secretly judges you.",
  "Clicking random things builds character.",
  "Click here‚Ä¶ actually don‚Äôt, maybe.",
  "This page self-destructs in 3‚Ä¶ 2‚Ä¶ just kidding.",
  "Don‚Äôt ask me how this works. I don‚Äôt know either.",
  "Don‚Äôt read this aloud. Unless you want to.",
  "Kuppy believes in you. (Mostly).",
  "Warning: May cause intense fun.",
  "If you see a bug, pretend it's a feature.",
  "The secret to success is not checking your email.",
  "Pro tip: Refreshing doesn't fix everything.",
  "It's not hoarding if it's games.",
  "Powered by sheer willpower and a lot of caffeine.",
];

function createGameCard(game, index, customGames, starredGames, defaultCount, loadPageFunc) {
  const isCustom = index >= defaultCount;
  const card = document.createElement('div');
  card.className = 'card';
  card.style.animationDelay = `${index * 0.05}s`;

  if (game.img) {
    const img = document.createElement('img');
    img.src = game.img;
    img.alt = game.name;
    card.appendChild(img);
  } else {
    card.innerHTML = `<span>${game.name}</span>`;
  }

  const title = document.createElement('div');
  title.className = 'card-title';
  title.textContent = game.name;
  card.appendChild(title);

  const starBtn = document.createElement('button');
  starBtn.className = 'starBtn';
  starBtn.innerHTML = starredGames.includes(game.name) ? '‚≠ê' : '‚òÜ';
  if (starredGames.includes(game.name)) starBtn.classList.add('starred');
  starBtn.title = starredGames.includes(game.name) ? 'Unstar Game' : 'Star Game';
  starBtn.onclick = (e) => {
    e.stopPropagation();
    let starred = JSON.parse(localStorage.getItem('starredGames') || '[]');
    if (starred.includes(game.name)) {
      starred = starred.filter(n => n !== game.name);
      starBtn.innerHTML = '‚òÜ';
      starBtn.classList.remove('starred');
      showToast(`Unstarred ${game.name}`, 'error');
    } else {
      starred.push(game.name);
      starBtn.innerHTML = '‚≠ê';
      starBtn.classList.add('starred');
      showToast(`Starred ${game.name}!`, 'success');
    }
    localStorage.setItem('starredGames', JSON.stringify(starred));
    displayStarredGames();
    loadPageFunc();
  };
  card.appendChild(starBtn);

  if (isCustom) {
    const deleteBtn = document.createElement('button');
    deleteBtn.className = 'deleteBtn';
    deleteBtn.innerHTML = 'üóëÔ∏è';
    deleteBtn.title = 'Delete Custom Game';
    deleteBtn.onclick = (e) => {
      e.stopPropagation();
      if (confirm(`Are you sure you want to delete custom game: ${game.name}?`)) {
        let saved = JSON.parse(localStorage.getItem('customPresets') || '[]');
        saved = saved.filter(g => g.name !== game.name || g.url !== game.url);
        localStorage.setItem('customPresets', JSON.stringify(saved));
        
        let starred = JSON.parse(localStorage.getItem('starredGames') || '[]');
        starred = starred.filter(n => n !== game.name);
        localStorage.setItem('starredGames', JSON.stringify(starred));
        
        showToast(`Deleted custom game: ${game.name}`, 'error');
        loadPageFunc();
        displayStarredGames();
      }
    };
    card.appendChild(deleteBtn);
  }

  card.onclick = () => {
    launchGame(game.url, game.name);
  };

  return card;
}

function launchGame(url, name = 'Unknown Game') {
  document.getElementById('fadeOverlay').classList.add('active');
  setTimeout(() => {
    window.location.href = url;
  }, 500);
  trackGameLaunch(name);
}

function loadGamesPage() {
  const grid = document.getElementById('allGamesGrid');
  grid.innerHTML = '';
  const saved = JSON.parse(localStorage.getItem('customPresets') || '[]');
  const starred = JSON.parse(localStorage.getItem('starredGames') || '[]');
  const allGames = [...defaultGames, ...saved];
  allGames.sort((a, b) => {
    const aStar = starred.includes(a.name);
    const bStar = starred.includes(b.name);
    if (aStar && !bStar) return -1;
    if (!aStar && bStar) return 1;
    return 0;
  });
  allGames.forEach((g, idx) => {
    const card = createGameCard(g, idx, saved, starred, defaultGames.length, loadGamesPage);
    grid.appendChild(card);
  });
}

function loadmultiGamesPage() {
  const grid = document.getElementById('multiGamesGrid');
  grid.innerHTML = '';
  const saved = JSON.parse(localStorage.getItem('customPresets') || '[]');
  const starred = JSON.parse(localStorage.getItem('starredGames') || '[]');
  const allGames = [...multiGames, ...saved];
  allGames.sort((a, b) => {
    const aStar = starred.includes(a.name);
    const bStar = starred.includes(b.name);
    if (aStar && !bStar) return -1;
    if (!aStar && bStar) return 1;
    return 0;
  });
  allGames.forEach((g, idx) => {
    const card = createGameCard(g, idx, saved, starred, multiGames.length, loadmultiGamesPage);
    grid.appendChild(card);
  });
}

function loadpuzzleGamesPage() {
  const grid = document.getElementById('puzzleGamesGrid');
  grid.innerHTML = '';
  const saved = JSON.parse(localStorage.getItem('customPresets') || '[]');
  const starred = JSON.parse(localStorage.getItem('starredGames') || '[]');
  const allGames = [...puzzleGames, ...saved];
  allGames.sort((a, b) => {
    const aStar = starred.includes(a.name);
    const bStar = starred.includes(b.name);
    if (aStar && !bStar) return -1;
    if (!aStar && bStar) return 1;
    return 0;
  });
  allGames.forEach((g, idx) => {
    const card = createGameCard(g, idx, saved, starred, puzzleGames.length, loadpuzzleGamesPage);
    grid.appendChild(card);
  });
}

function loadobbyGamesPage() {
  const grid = document.getElementById('obbyGamesGrid');
  grid.innerHTML = '';
  const saved = JSON.parse(localStorage.getItem('customPresets') || '[]');
  const starred = JSON.parse(localStorage.getItem('starredGames') || '[]');
  const allGames = [...obbyGames, ...saved];
  allGames.sort((a, b) => {
    const aStar = starred.includes(a.name);
    const bStar = starred.includes(b.name);
    if (aStar && !bStar) return -1;
    if (!aStar && bStar) return 1;
    return 0;
  });
  allGames.forEach((g, idx) => {
    const card = createGameCard(g, idx, saved, starred, obbyGames.length, loadobbyGamesPage);
    grid.appendChild(card);
  });
}

function loadsportsGamesPage() {
  const grid = document.getElementById('sportsGamesGrid');
  grid.innerHTML = '';
  const saved = JSON.parse(localStorage.getItem('customPresets') || '[]');
  const starred = JSON.parse(localStorage.getItem('starredGames') || '[]');
  const allGames = [...sportsGames, ...saved];
  allGames.sort((a, b) => {
    const aStar = starred.includes(a.name);
    const bStar = starred.includes(b.name);
    if (aStar && !bStar) return -1;
    if (!aStar && bStar) return 1;
    return 0;
  });
  allGames.forEach((g, idx) => {
    const card = createGameCard(g, idx, saved, starred, sportsGames.length, loadsportsGamesPage);
    grid.appendChild(card);
  });
}

function showGamesPage() {
  const home = document.getElementById('homePage');
  const games = document.getElementById('gamesPage');
  const multi = document.getElementById('multigamesPage');
  const puzzle = document.getElementById('puzzlegamesPage');
  const obby = document.getElementById('obbygamesPage');
  const sports = document.getElementById('sportsgamesPage');

  home.style.opacity = '0';
  multi.style.display = 'none';
  puzzle.style.display = 'none';
  obby.style.display = 'none';
  sports.style.display = 'none';
  games.style.display = 'flex';
  document.getElementById('infoShell').style.display = 'none';

  requestAnimationFrame(() => {
    home.style.transition = 'opacity 0.5s';
    setTimeout(() => {
      home.style.display = 'none';
      games.classList.add('show');
      loadGamesPage();
    }, 500);
  });
}

function showMultiGamesPage() {
  const home = document.getElementById('homePage');
  const games = document.getElementById('gamesPage');
  const multi = document.getElementById('multigamesPage');
  const puzzle = document.getElementById('puzzlegamesPage');
  const obby = document.getElementById('obbygamesPage');
  const sports = document.getElementById('sportsgamesPage');

  home.style.opacity = '0';
  games.style.display = 'none';
  puzzle.style.display = 'none';
  obby.style.display = 'none';
  sports.style.display = 'none';
  multi.style.display = 'flex';
  document.getElementById('infoShell').style.display = 'none';

  requestAnimationFrame(() => {
    home.style.transition = 'opacity 0.5s';
    setTimeout(() => {
      home.style.display = 'none';
      multi.classList.add('show');
      loadmultiGamesPage();
    }, 500);
  });
}

function showPuzzleGamesPage() {
  const home = document.getElementById('homePage');
  const games = document.getElementById('gamesPage');
  const multi = document.getElementById('multigamesPage');
  const puzzle = document.getElementById('puzzlegamesPage');
  const obby = document.getElementById('obbygamesPage');
  const sports = document.getElementById('sportsgamesPage');

  home.style.opacity = '0';
  games.style.display = 'none';
  multi.style.display = 'none';
  obby.style.display = 'none';
  sports.style.display = 'none';
  puzzle.style.display = 'flex';
  document.getElementById('infoShell').style.display = 'none';

  requestAnimationFrame(() => {
    home.style.transition = 'opacity 0.5s';
    setTimeout(() => {
      home.style.display = 'none';
      puzzle.classList.add('show');
      loadpuzzleGamesPage();
    }, 500);
  });
}

function showObbyGamesPage() {
  const home = document.getElementById('homePage');
  const games = document.getElementById('gamesPage');
  const multi = document.getElementById('multigamesPage');
  const puzzle = document.getElementById('puzzlegamesPage');
  const obby = document.getElementById('obbygamesPage');
  const sports = document.getElementById('sportsgamesPage');

  home.style.opacity = '0';
  games.style.display = 'none';
  multi.style.display = 'none';
  puzzle.style.display = 'none';
  sports.style.display = 'none';
  obby.style.display = 'flex';
  document.getElementById('infoShell').style.display = 'none';

  requestAnimationFrame(() => {
    home.style.transition = 'opacity 0.5s';
    setTimeout(() => {
      home.style.display = 'none';
      obby.classList.add('show');
      loadobbyGamesPage();
    }, 500);
  });
}

function showSportsGamesPage() {
  const home = document.getElementById('homePage');
  const games = document.getElementById('gamesPage');
  const multi = document.getElementById('multigamesPage');
  const puzzle = document.getElementById('puzzlegamesPage');
  const obby = document.getElementById('obbygamesPage');
  const sports = document.getElementById('sportsgamesPage');

  home.style.opacity = '0';
  games.style.display = 'none';
  multi.style.display = 'none';
  puzzle.style.display = 'none';
  obby.style.display = 'none';
  sports.style.display = 'flex';
  document.getElementById('infoShell').style.display = 'none';

  requestAnimationFrame(() => {
    home.style.transition = 'opacity 0.5s';
    setTimeout(() => {
      home.style.display = 'none';
      sports.classList.add('show');
      loadsportsGamesPage();
    }, 500);
  });
}

function showHomePage() {
  const home = document.getElementById('homePage');
  const pages = [
    document.getElementById('gamesPage'),
    document.getElementById('multigamesPage'),
    document.getElementById('puzzlegamesPage'),
    document.getElementById('obbygamesPage'),
    document.getElementById('sportsgamesPage')
  ];

  pages.forEach(page => {
    page.style.transform = 'translateX(100%)';
    page.style.opacity = '0';
    page.classList.remove('show');
  });

  setTimeout(() => {
    pages.forEach(page => {
      page.style.display = 'none';
      page.style.transform = '';
    });
    const weatherEnabled = localStorage.getItem('kuppyWeatherEnabled') === 'true';
    document.getElementById('infoShell').style.display = weatherEnabled ? 'flex' : 'none';
    home.style.display = 'block';
    home.style.transform = 'translateX(-100%)';
    home.style.opacity = '0';
    requestAnimationFrame(() => {
      home.style.transition = 'transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.5s';
      home.style.transform = 'translateX(0)';
      home.style.opacity = '1';
      displayStarredGames();
    });
  }, 500);
}


function startTyping() {
  if (KuppyState.isTyping) return;
  KuppyState.isTyping = true;
  const titleEl = document.getElementById('typedTitle');
  const text = quotes[Math.floor(Math.random() * quotes.length)];
  titleEl.textContent = '';
  let i = 0;
  const interval = setInterval(() => {
    if (i < text.length) {
      titleEl.textContent += text.charAt(i);
      i++;
      if (KuppyState.soundEnabled) {
        playSound(200, 0.01, 'sawtooth');
      }
    } else {
      clearInterval(interval);
      KuppyState.isTyping = false;
      setTimeout(() => {
        titleEl.textContent = '';
        startTyping();
      }, 8000);
    }
  }, 50);
}

function updateTime() {
  const now = new Date();
  const timeDisplay = document.getElementById('timeDisplay');
  const dateDisplay = document.getElementById('dateDisplay');
  if (timeDisplay) {
    timeDisplay.textContent = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
  }
  if (dateDisplay) {
    dateDisplay.textContent = now.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
  }
}
updateTime();
setInterval(updateTime, 1000);

function createConfetti(x, y, count) {
  const colors = ['#fef08a', '#facc15', '#007bff', '#9333ea', '#10b981'];
  for (let i = 0; i < count; i++) {
    const confetti = document.createElement('div');
    confetti.className = 'confetti';
    confetti.style.left = x + 'px';
    confetti.style.top = y + 'px';
    confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
    confetti.style.animationDuration = (Math.random() * 2 + 1) + 's';
    confetti.style.animationDelay = (Math.random() * 0.5) + 's';
    const angle = (Math.random() * 360) * Math.PI / 180;
    const velocity = Math.random() * 200 + 100;
    confetti.style.setProperty('--tx', Math.cos(angle) * velocity + 'px');
    confetti.style.setProperty('--ty', Math.sin(angle) * velocity + 'px');
    document.body.appendChild(confetti);
    setTimeout(() => confetti.remove(), 3000);
  }
}

function incrementCombo() {
  KuppyState.combo++;
  clearTimeout(KuppyState.comboTimer);
  KuppyState.comboTimer = setTimeout(() => {
    KuppyState.combo = 0;
  }, 2000);
  if (KuppyState.combo >= 2) {
    const comboDiv = document.getElementById('comboCounter');
    comboDiv.textContent = `x${KuppyState.combo} COMBO!`;
    comboDiv.classList.remove('show');
    void comboDiv.offsetWidth;
    comboDiv.classList.add('show');
    setTimeout(() => {
      comboDiv.classList.remove('show');
    }, 1000);
  }
}

function screenShake() {
  document.body.classList.add('shake');
  setTimeout(() => {
    document.body.classList.remove('shake');
  }, 500);
}

function trackGameLaunch(gameName) {
  KuppyState.stats.launches++;
  if (gameName !== 'Unknown Game') {
    KuppyState.stats.games[gameName] = (KuppyState.stats.games[gameName] || 0) + 1;
  }
  incrementCombo();
  saveStats();
}

function saveStats() {
  localStorage.setItem('kuppyStats', JSON.stringify(KuppyState.stats));
}

function updateStatsDisplay() {
  document.getElementById('statLaunches').textContent = KuppyState.stats.launches;
  document.getElementById('statFavorites').textContent = JSON.parse(localStorage.getItem('starredGames') || '[]').length;
  const totalMinutes = Math.floor(KuppyState.stats.playtime / 60);
  const hours = Math.floor(totalMinutes / 60);
  const minutes = totalMinutes % 60;
  document.getElementById('statPlaytime').textContent = hours > 0 ? `${hours}h ${minutes}m` : `${minutes}m`;
  const mostPlayed = Object.keys(KuppyState.stats.games).reduce((a, b) => KuppyState.stats.games[a] > KuppyState.stats.games[b] ? a : b, null);
  document.getElementById('statMostPlayed').textContent = mostPlayed ? `${mostPlayed} (${KuppyState.stats.games[mostPlayed]} launches)` : 'None';
}

function showStatsPanel() {
  updateStatsDisplay();
  const panel = document.getElementById('statsPanel');
  panel.classList.add('show');
  document.getElementById('statsClose').onclick = () => {
    panel.classList.remove('show');
  };
}

// Function to handle game card clicks
function handleCardClick(gameName) {
  trackGameLaunch(gameName);
}

// Typing for welcome overlay
document.addEventListener('DOMContentLoaded', () => {
  const text = "KuppyCloaker";
  const title = document.getElementById('welcomeText');
  let i = 0;
  const interval = setInterval(() => {
    if (i < text.length) {
      title.textContent += text.charAt(i);
      title.style.opacity = 1;
      i++;
    } else {
      clearInterval(interval);
    }
  }, 100);
});

// Sound functions
function playSound(frequency, duration, type) {
  if (!KuppyState.soundEnabled) return;
  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  const oscillator = audioCtx.createOscillator();
  const gainNode = audioCtx.createGain();

  oscillator.connect(gainNode);
  gainNode.connect(audioCtx.destination);

  oscillator.frequency.setValueAtTime(frequency, audioCtx.currentTime);
  oscillator.type = type;

  gainNode.gain.setValueAtTime(0.001, audioCtx.currentTime);
  gainNode.gain.exponentialRampToValueAtTime(0.1, audioCtx.currentTime + 0.05);
  gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);

  oscillator.start();
  setTimeout(() => {
    oscillator.stop();
  }, duration * 1000);
}

// Weather functions
async function fetchWeather() {
  if (localStorage.getItem('kuppyWeatherEnabled') !== 'true') return;
  const key = 'a45f91753c30a6f446059e09d0124b89';
  let lat = localStorage.getItem('kuppyWeatherLat');
  let lon = localStorage.getItem('kuppyWeatherLon');
  let city = localStorage.getItem('kuppyWeatherCity');

  if (!lat || !lon) {
    try {
      const position = await new Promise((resolve, reject) => {
        navigator.geolocation.getCurrentPosition(resolve, reject);
      });
      lat = position.coords.latitude;
      lon = position.coords.longitude;
      localStorage.setItem('kuppyWeatherLat', lat);
      localStorage.setItem('kuppyWeatherLon', lon);
    } catch (e) {
      // Fallback for no location access
      console.warn("Geolocation denied or failed, using default city.");
      city = 'New York';
    }
  }

  const url = city 
    ? `https://api.openweathermap.org/data/2.5/weather?q=${city}&units=imperial&appid=${key}`
    : `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&units=imperial&appid=${key}`;
  
  try {
    const response = await fetch(url);
    const data = await response.json();

    if (data.cod !== 200) throw new Error(data.message);

    document.getElementById('temperature').textContent = `${Math.round(data.main.temp)}¬∞F`;
    document.getElementById('weatherDesc').textContent = data.weather[0].description;
    document.getElementById('feelsLike').textContent = `${Math.round(data.main.feels_like)}¬∞F`;
    document.getElementById('humidity').textContent = `${data.main.humidity}%`;
    document.getElementById('windSpeed').textContent = `${Math.round(data.wind.speed)} mph`;
    
    const iconEl = document.getElementById('weatherIcon');
    iconEl.textContent = getWeatherIcon(data.weather[0].icon);
    iconEl.className = 'weather-icon';

    // Set background effects based on weather
    document.body.classList.remove('weather-rain', 'weather-snow', 'weather-sunny');
    if (data.weather[0].main.toLowerCase().includes('rain')) {
      document.body.classList.add('weather-rain');
      iconEl.classList.add('rainy');
    } else if (data.weather[0].main.toLowerCase().includes('snow')) {
      document.body.classList.add('weather-snow');
    } else if (data.weather[0].main.toLowerCase().includes('clear')) {
      document.body.classList.add('weather-sunny');
      iconEl.classList.add('sunny');
    }

  } catch (error) {
    console.error('Weather API error:', error);
    document.getElementById('weatherDesc').textContent = 'Weather unavailable';
    document.getElementById('temperature').textContent = '--¬∞F';
  }
}

function getWeatherIcon(iconCode) {
  const map = {
    '01d': '‚òÄÔ∏è', '01n': 'üåô', // clear sky
    '02d': 'üå§Ô∏è', '02n': '‚òÅÔ∏è', // few clouds
    '03d': '‚òÅÔ∏è', '03n': '‚òÅÔ∏è', // scattered clouds
    '04d': '‚òÅÔ∏è', '04n': '‚òÅÔ∏è', // broken clouds
    '09d': 'üåßÔ∏è', '09n': 'üåßÔ∏è', // shower rain
    '10d': 'üå¶Ô∏è', '10n': 'üåßÔ∏è', // rain
    '11d': '‚õàÔ∏è', '11n': '‚õàÔ∏è', // thunderstorm
    '13d': '‚ùÑÔ∏è', '13n': '‚ùÑÔ∏è', // snow
    '50d': 'üå´Ô∏è', '50n': 'üå´Ô∏è'  // mist
  };
  return map[iconCode] || '‚ùì';
}

if (localStorage.getItem('kuppyWeatherEnabled') === 'true') {
  fetchWeather();
  setInterval(fetchWeather, 600000);
}

document.addEventListener('mousemove', (e) => {
  const cards = document.querySelectorAll('.card');
  cards.forEach(card => {
    const rect = card.getBoundingClientRect();
    const cardCenterX = rect.left + rect.width / 2;
    const cardCenterY = rect.top + rect.height / 2;
    const distanceX = e.clientX - cardCenterX;
    const distanceY = e.clientY - cardCenterY;
    const distance = Math.sqrt(distanceX * distanceX + distanceY * distanceY);
    if (distance < 200) {
      const angleX = (distanceY / rect.height) * 15;
      const angleY = (distanceX / rect.width) * -15;
      card.style.transform = `perspective(1000px) rotateX(${angleX}deg) rotateY(${angleY}deg) scale(1.02)`;
    } else {
      card.style.transform = 'perspective(1000px) rotateX(0) rotateY(0) scale(1)';
    }
  });
});

// Login and Setup Logic
const loginButton = document.getElementById('loginButton');
const guestLogin = document.getElementById('guestLogin');
const websiteInput = document.getElementById('websiteInput');
const goButton = document.getElementById('goButton');
const loginShell = document.getElementById('loginShell');
const homePage = document.getElementById('homePage');
const loginUsername = document.getElementById('loginUsername');
const loginPassword = document.getElementById('loginPassword');
const loginMsg = document.getElementById('loginMsg');
const userDisplay = document.getElementById('userDisplay');

const users = {
  "kuppycloakerforlife": "hahaifyoureseeingthisthenyoufoundmysecret",
};

loginShell.classList.add('fade');
homePage.classList.add('fade');

if (localStorage.getItem('kuppyTrusted') === 'true') {
  const autoUser = localStorage.getItem('kuppyAutoUser') || 'Kuppy';
  try {
    loginShell.classList.add('hidden');
    setTimeout(() => {
      loginShell.style.display = 'none';
      const weatherEnabled = localStorage.getItem('kuppyWeatherEnabled') === 'true';
      document.getElementById('infoShell').style.display = weatherEnabled ? 'flex' : 'none';
      homePage.style.display = 'block';
      setTimeout(() => {
        homePage.classList.remove('hidden');
        startTyping();
      }, 10);
      userDisplay.textContent = autoUser;
      displayStarredGames();
    }, 500);
  } catch (e) {
    console.warn('Auto-login init failed:', e);
  }
}

userDisplay.addEventListener('click', () => {
  const confirmSignOut = confirm("Are you sure you want to log out?");
  if (!confirmSignOut) return;
  homePage.classList.add('hidden');
  const infoShell = document.getElementById('infoShell');
  if (infoShell) infoShell.style.display = 'none';

  // Clear weather details on sign out
  const tempEl = document.getElementById('temperature');
  const descEl = document.getElementById('weatherDesc');
  const feelsEl = document.getElementById('feelsLike');
  const humEl = document.getElementById('humidity');
  const windEl = document.getElementById('windSpeed');
  const iconEl = document.getElementById('weatherIcon');
  if (tempEl) tempEl.textContent = '--¬∞F';
  if (descEl) descEl.textContent = '';
  if (feelsEl) feelsEl.textContent = '--¬∞F';
  if (humEl) humEl.textContent = '--%';
  if (windEl) windEl.textContent = '-- mph';
  if (iconEl) iconEl.textContent = '‚òÄÔ∏è';

  setTimeout(() => {
    loginShell.style.display = 'flex';
    loginShell.classList.remove('hidden');
    homePage.style.display = 'none';
    localStorage.removeItem('kuppyTrusted');
    localStorage.removeItem('kuppyAutoUser');
    document.querySelector('.starred-games-container').innerHTML = ''; // Clear starred icons
  }, 500);
});

loginButton.addEventListener('click', () => {
  const user = loginUsername.value.toLowerCase();
  const pass = loginPassword.value;
  if (users[user] === pass) {
    loginMsg.style.opacity = '0';
    localStorage.setItem('kuppyTrusted', 'true');
    localStorage.setItem('kuppyAutoUser', user);
    loginShell.classList.add('hidden');
    setTimeout(() => {
      loginShell.style.display = 'none';
      const weatherEnabled = localStorage.getItem('kuppyWeatherEnabled') === 'true';
      document.getElementById('infoShell').style.display = weatherEnabled ? 'flex' : 'none';
      homePage.style.display = 'block';
      setTimeout(() => {
        homePage.classList.remove('hidden');
        startTyping();
      }, 10);
      userDisplay.textContent = user;
      displayStarredGames();
    }, 500);
  } else {
    loginMsg.textContent = "Incorrect username or password";
    loginMsg.style.opacity = '1';
  }
});

guestLogin.addEventListener('click', () => {
  loginMsg.style.opacity = '0';
  loginShell.classList.add('hidden');
  setTimeout(() => {
    loginShell.style.display = 'none';
    const weatherEnabled = localStorage.getItem('kuppyWeatherEnabled') === 'true';
    document.getElementById('infoShell').style.display = weatherEnabled ? 'flex' : 'none';
    homePage.style.display = 'block';
    setTimeout(() => {
      homePage.classList.remove('hidden');
      startTyping();
    }, 10);
    userDisplay.textContent = 'Guest';
    displayStarredGames();
  }, 500);
});

goButton.addEventListener('click', () => {
  const url = websiteInput.value.trim();
  if (url) {
    let finalUrl = url;
    if (!url.startsWith('http://') && !url.startsWith('https://')) {
      finalUrl = 'https://' + url;
    }
    launchGame(finalUrl);
  } else {
    showToast('Please enter a valid URL.', 'error');
  }
});

websiteInput.addEventListener('keypress', (e) => {
  if (e.key === 'Enter') {
    e.preventDefault();
    goButton.click();
  }
});

document.getElementById('settingsIcon').onclick = () => {
  document.getElementById('settingsMenu').classList.toggle('show');
};

document.getElementById('weatherToggle').onclick = () => {
  const weatherEnabled = localStorage.getItem('kuppyWeatherEnabled') === 'true';
  localStorage.setItem('kuppyWeatherEnabled', !weatherEnabled);
  if (!weatherEnabled) {
    // Enable and fetch
    document.getElementById('infoShell').style.display = 'flex';
    fetchWeather();
    showToast('üå§Ô∏è Weather widget enabled!', 'success');
    KuppyState.stats.weatherToggles++;
    saveStats();
  } else {
    // Disable
    document.getElementById('infoShell').style.display = 'none';
    document.body.classList.remove('weather-rain', 'weather-snow', 'weather-sunny');
    showToast('Weather widget disabled.', 'error');
  }
};

document.getElementById('lightToggle').onclick = () => {
  const isLight = document.body.classList.toggle('light-theme');
  localStorage.setItem('kuppyLightTheme', isLight);
  showToast(isLight ? 'üí° Light Theme Activated' : 'üåô Dark Theme Activated', 'success');
};

if (localStorage.getItem('kuppyLightTheme') === 'true') {
  document.body.classList.add('light-theme');
}

// Password Logic
document.getElementById('forgotPassword').addEventListener('click', (e) => {
  e.preventDefault();
  const entered = prompt("Enter the special code to auto-login (Hint: it's 'kuppy')");
  if (entered === 'kuppy') {
    localStorage.setItem('kuppyTrusted', 'true');
    localStorage.setItem('kuppyAutoUser', 'Kuppy');
    showToast('‚úÖ Correct code! You will now be logged in automatically on this device.', 'success');
    try {
      loginShell.classList.add('hidden');
      setTimeout(() => {
        loginShell.style.display = 'none';
        const weatherEnabled = localStorage.getItem('kuppyWeatherEnabled') === 'true';
        document.getElementById('infoShell').style.display = weatherEnabled ? 'flex' : 'none';
        homePage.style.display = 'block';
        setTimeout(() => {
          homePage.classList.remove('hidden');
          startTyping();
        }, 10);
        userDisplay.textContent = 'Kuppy';
        displayStarredGames();
      }, 500);
    } catch (e) {
      console.warn('Auto-login failed:', e);
    }
  } else if (entered !== null) {
    alert("‚ùå Wrong code.");
  }
});

const passwordInput = document.getElementById('loginPassword');
const togglePassword = document.getElementById('togglePassword');
togglePassword.addEventListener('click', () => {
  const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
  passwordInput.setAttribute('type', type);
  togglePassword.textContent = type === 'password' ? 'üëÅÔ∏è' : 'üôà';
});

const bgUpload = document.createElement('input');
bgUpload.type = 'file';
bgUpload.accept = 'image/*';
bgUpload.id = 'bgUpload';
bgUpload.style.display = 'none';
document.body.appendChild(bgUpload);

const bgButton = document.createElement('div');
bgButton.className = 'fab-item';
bgButton.id = 'bgButton';
bgButton.innerHTML = 'üñºÔ∏è Background';
bgButton.onclick = () => bgUpload.click();

bgUpload.addEventListener('change', (event) => {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    const dataURL = e.target.result;
    localStorage.setItem('customBackground', dataURL);
    document.body.style.backgroundImage = `url(${dataURL})`;
  };
  reader.readAsDataURL(file);
});

window.addEventListener('load', () => {
  const savedBG = localStorage.getItem('customBackground');
  if (savedBG) {
    document.body.style.backgroundImage = `url(${savedBG})`;
    document.body.style.backgroundSize = 'cover';
    document.body.style.backgroundPosition = 'center';
  }
});


document.getElementById('allGamesBtn').onclick = showGamesPage;
document.getElementById('multiGamesBtn').onclick = showMultiGamesPage;
document.getElementById('puzzleGamesBtn').onclick = showPuzzleGamesPage;
document.getElementById('obbyGamesBtn').onclick = showObbyGamesPage;
document.getElementById('sportsGamesBtn').onclick = showSportsGamesPage;

document.getElementById('backBtn').onclick = showHomePage;
document.getElementById('multiBackBtn').onclick = showHomePage;
document.getElementById('puzzleBackBtn').onclick = showHomePage;
document.getElementById('obbyBackBtn').onclick = showHomePage;
document.getElementById('sportsBackBtn').onclick = showHomePage;


// Modules System - Simplified to be accessible without FAB
document.getElementById('modulesClose').onclick = ModulesSystem.closePanel.bind(ModulesSystem);
document.getElementById('modulesBackdrop').onclick = ModulesSystem.closePanel.bind(ModulesSystem);
document.querySelectorAll('.module-card').forEach(card => {
  card.onclick = (e) => {
    const moduleType = e.currentTarget.dataset.module;
    if (moduleType === 'postit') {
      const centerX = Math.max(50, (window.innerWidth / 2) - 140);
      const centerY = Math.max(50, (window.innerHeight / 2) - 140);
      ModulesSystem.createWidget('postit', { position: { x: centerX, y: centerY } });
      if (typeof showToast === 'function') {
        showToast('üìù Post-it note added!', 'success');
      }
      ModulesSystem.closePanel();
    } else if (moduleType === 'weather') {
      const centerX = Math.max(50, (window.innerWidth / 2) - 160);
      const centerY = Math.max(50, (window.innerHeight / 2) - 80);
      ModulesSystem.createWidget('weather', { position: { x: centerX, y: centerY } });
      if (localStorage.getItem('kuppyWeatherEnabled') !== 'true') {
        localStorage.setItem('kuppyWeatherEnabled', 'true');
      }
      if (document.getElementById('homePage').style.display !== 'none') {
        const weatherEnabled = localStorage.getItem('kuppyWeatherEnabled') === 'true';
        document.getElementById('infoShell').style.display = weatherEnabled ? 'flex' : 'none';
      }
      fetchWeather();
      if (typeof showToast === 'function') {
        showToast('üå§Ô∏è Weather widget enabled!', 'success');
      }
      ModulesSystem.closePanel();
    } else if (moduleType === 'timer') {
      const centerX = Math.max(50, (window.innerWidth / 2) - 160);
      const centerY = Math.max(50, (window.innerHeight / 2) - 140);
      ModulesSystem.createWidget('timer', { position: { x: centerX, y: centerY } });
      if (typeof showToast === 'function') {
        showToast('‚è∞ Class timer added!', 'success');
      }
      ModulesSystem.closePanel();
    } else {
      if (typeof showToast === 'function') {
        showToast('This module is coming soon!', 'error');
      }
    }
  };
});


// Starred Games Display Logic
function displayStarredGames() {
  const container = document.querySelector('.starred-games-container');
  container.innerHTML = '';
  const starred = JSON.parse(localStorage.getItem('starredGames') || '[]');
  const allGames = [...defaultGames, ...multiGames, ...puzzleGames, ...obbyGames, ...sportsGames, ...JSON.parse(localStorage.getItem('customPresets') || '[]')];

  starred.forEach(name => {
    const game = allGames.find(g => g.name === name);
    if (game && game.img) {
      const icon = document.createElement('div');
      icon.className = 'starred-game-icon';
      icon.title = game.name;
      icon.style.left = `${Math.random() * (window.innerWidth - 100) + 10}px`;
      icon.style.top = `${Math.random() * (window.innerHeight - 100) + 10}px`;

      const img = document.createElement('img');
      img.src = game.img;
      img.alt = game.name;
      icon.appendChild(img);

      icon.onclick = (e) => {
        e.stopPropagation();
        launchGame(game.url, game.name);
      };

      // Draggable logic
      let isDragging = false;
      let offsetX, offsetY;

      icon.onmousedown = (e) => {
        isDragging = true;
        icon.classList.add('dragging');
        offsetX = e.clientX - icon.getBoundingClientRect().left;
        offsetY = e.clientY - icon.getBoundingClientRect().top;
      };

      document.onmousemove = (e) => {
        if (!isDragging) return;
        let newX = e.clientX - offsetX;
        let newY = e.clientY - offsetY;

        // Keep inside bounds
        newX = Math.max(0, Math.min(newX, window.innerWidth - icon.offsetWidth));
        newY = Math.max(0, Math.min(newY, window.innerHeight - icon.offsetHeight));

        icon.style.left = `${newX}px`;
        icon.style.top = `${newY}px`;
      };

      document.onmouseup = () => {
        if (isDragging) {
          isDragging = false;
          icon.classList.remove('dragging');
        }
      };

      container.appendChild(icon);
    }
  });
}

// Toast function
function showToast(message, type = 'success') {
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.textContent = message;
  document.body.appendChild(toast);
  setTimeout(() => {
    toast.style.opacity = '0';
    toast.style.transform = 'translateX(100px)';
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}

// Focus Mode Logic (simplified as its button was removed)
function startFocusMode(minutes) {
  if (typeof showToast === 'function') {
    showToast(`üßò Starting ${minutes} minute focus mode...`, 'success');
  }
  const overlay = document.createElement('div');
  overlay.className = 'focus-mode-overlay';
  overlay.innerHTML = `
    <div class="focus-mode-title">Focus Mode</div>
    <div class="focus-mode-timer" id="focusTimer">--:--</div>
    <div class="focus-mode-message">Stay focused! KuppyCloaker is locked.</div>
    <button class="focus-mode-exit">Exit Focus Mode</button>
  `;
  document.body.appendChild(overlay);

  const endTime = Date.now() + (minutes * 60 * 1000);
  const updateFocusTimer = () => {
    const remaining = endTime - Date.now();
    if (remaining <= 0) {
      overlay.remove();
      if (typeof showToast === 'function') {
        showToast('‚úÖ Focus session complete!', 'success');
      }
      createConfetti(window.innerWidth / 2, window.innerHeight / 2, 50);
      return;
    }
    const mins = Math.floor(remaining / 60000);
    const secs = Math.floor((remaining % 60000) / 1000).toString().padStart(2, '0');
    document.getElementById('focusTimer').textContent = `${mins}:${secs}`;
    requestAnimationFrame(updateFocusTimer);
  };
  requestAnimationFrame(updateFocusTimer);

  document.querySelector('.focus-mode-exit').onclick = () => {
    if (confirm("Are you sure you want to end your focus session early?")) {
      overlay.remove();
      if (typeof showToast === 'function') {
        showToast('Focus mode ended.', 'error');
      }
    }
  };
}

// Particles for background
const canvas = document.getElementById('particleCanvas');
const ctx = canvas.getContext('2d');
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

window.addEventListener('resize', () => {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
});

class Particle {
  constructor() {
    this.x = Math.random() * canvas.width;
    this.y = Math.random() * canvas.height;
    this.size = Math.random() * 2 + 0.5;
    this.speedX = Math.random() * 1.5 - 0.75;
    this.speedY = Math.random() * 1.5 - 0.75;
    this.color = 'rgba(0, 123, 255, 0.4)';
  }

  update() {
    this.x += this.speedX;
    this.y += this.speedY;

    if (this.x > canvas.width || this.x < 0) this.speedX = -this.speedX;
    if (this.y > canvas.height || this.y < 0) this.speedY = -this.speedY;
  }

  draw() {
    ctx.fillStyle = this.color;
    ctx.beginPath();
    ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
    ctx.fill();
  }
}

const particles = [];
for (let i = 0; i < 80; i++) {
  particles.push(new Particle());
}

const trail = [];
const trailLength = 8;
document.addEventListener('mousemove', (e) => {
  trail.push({ x: e.clientX, y: e.clientY, time: Date.now() });
  if (trail.length > trailLength) {
    trail.shift();
  }
});

function drawCursorTrail() {
  const now = Date.now();
  trail.forEach((point, index) => {
    const age = now - point.time;
    if (age < 500) {
      const opacity = (1 - age / 500) * 0.3;
      const size = 3 - (age / 500) * 2;
      ctx.fillStyle = `rgba(0, 123, 255, ${opacity})`;
      ctx.beginPath();
      ctx.arc(point.x, point.y, size, 0, Math.PI * 2);
      ctx.fill();
    }
  });
}

function animateParticles() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  particles.forEach(p => {
    p.update();
    p.draw();
  });
  drawCursorTrail();
  requestAnimationFrame(animateParticles);
}

animateParticles();

// Module System Logic
const ModulesSystem = {
  widgets: [],
  nextId: 1,
  init() {
    try {
      const saved = localStorage.getItem('kuppyWidgets');
      if (saved) {
        this.widgets = JSON.parse(saved);
        this.widgets.forEach(widget => this.renderWidget(widget));
      }
    } catch (e) {
      console.error("Error loading widgets:", e);
      this.widgets = [];
    }
  },
  saveWidgets() {
    localStorage.setItem('kuppyWidgets', JSON.stringify(this.widgets.map(w => ({
      id: w.id,
      type: w.type,
      data: w.data,
      position: { x: w.element.style.left, y: w.element.style.top }
    }))));
  },
  createWidget(type, initialData = {}) {
    const newWidget = {
      id: this.nextId++,
      type: type,
      data: initialData.data || {},
      position: initialData.position || { x: '50px', y: '50px' },
      element: null,
    };
    this.widgets.push(newWidget);
    this.renderWidget(newWidget);
    this.saveWidgets();
  },
  renderWidget(widget) {
    const el = document.createElement('div');
    el.className = `${widget.type}-widget`;
    el.dataset.widgetId = widget.id;
    el.style.left = widget.position.x;
    el.style.top = widget.position.y;
    widget.element = el;

    const closeBtn = document.createElement('button');
    closeBtn.className = 'widget-close';
    closeBtn.innerHTML = '√ó';
    closeBtn.title = 'Close Module';
    closeBtn.onclick = () => this.deleteWidget(widget.id);
    el.appendChild(closeBtn);

    if (widget.type === 'postit') {
      const textarea = document.createElement('textarea');
      textarea.className = 'post-it-text';
      textarea.placeholder = 'Type your notes here...';
      textarea.value = widget.data.content || '';
      textarea.oninput = () => {
        widget.data.content = textarea.value;
        this.saveWidgets();
      };
      el.appendChild(textarea);
    } else if (widget.type === 'weather') {
      el.innerHTML = `
        <button class="widget-close" title="Close Module">√ó</button>
        <div class="weather-widget-header">
          <div>
            <div class="weather-widget-temp" id="widget-temp-${widget.id}">--¬∞F</div>
            <div class="weather-widget-city" id="widget-city-${widget.id}">Location</div>
          </div>
          <div class="weather-widget-icon" id="widget-icon-${widget.id}">‚òÄÔ∏è</div>
        </div>
        <div class="weather-widget-details">
          <div class="weather-widget-detail">Feels Like: <span id="widget-feels-${widget.id}">--¬∞F</span></div>
          <div class="weather-widget-detail">Humidity: <span id="widget-humidity-${widget.id}">--%</span></div>
          <div class="weather-widget-detail">Wind: <span id="widget-wind-${widget.id}">-- mph</span></div>
        </div>
      `;
      this.updateWeatherWidget(widget.id);
    } else if (widget.type === 'timer') {
      el.innerHTML = `
        <button class="widget-close" title="Close Module">√ó</button>
        <h3>Class Timer</h3>
        <div class="timer-message" id="widget-timer-msg-${widget.id}">Loading schedule...</div>
        <div class="timer-display" id="widget-timer-display-${widget.id}">--:--</div>
        <button class="timer-settings-btn" id="widget-timer-settings-${widget.id}">Edit Schedule</button>
      `;
      document.getElementById(`widget-timer-settings-${widget.id}`).onclick = (e) => {
        e.stopPropagation();
        this.showTimerSettings(widget);
      };
      this.initTimerWidget(widget);
    }

    document.body.appendChild(el);
    this.makeDraggable(el, widget);
    closeBtn.onclick = () => this.deleteWidget(widget.id);
  },
  deleteWidget(id) {
    const index = this.widgets.findIndex(w => w.id === id);
    if (index !== -1) {
      this.widgets[index].element.remove();
      this.widgets.splice(index, 1);
      this.saveWidgets();
    }
  },
  makeDraggable(el, widget) {
    let isDragging = false;
    let offsetX, offsetY;

    el.onmousedown = (e) => {
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'BUTTON' || e.target.classList.contains('widget-close')) {
        return; // Don't drag if clicking an interactive element
      }
      isDragging = true;
      offsetX = e.clientX - el.getBoundingClientRect().left;
      offsetY = e.clientY - el.getBoundingClientRect().top;
      el.style.cursor = 'grabbing';
      el.style.zIndex = this.nextId + 100; // Bring to front
      this.nextId++;
    };

    document.onmousemove = (e) => {
      if (!isDragging) return;
      let newX = e.clientX - offsetX;
      let newY = e.clientY - offsetY;

      newX = Math.max(0, newX);
      newY = Math.max(0, newY);

      el.style.left = `${newX}px`;
      el.style.top = `${newY}px`;
      widget.position = { x: `${newX}px`, y: `${newY}px` };
    };

    document.onmouseup = () => {
      if (isDragging) {
        isDragging = false;
        el.style.cursor = 'move';
        this.saveWidgets();
      }
    };
  },
  showPanel() {
    document.getElementById('modulesBackdrop').classList.add('show');
    document.getElementById('modulesPanel').classList.add('show');
  },
  closePanel() {
    document.getElementById('modulesBackdrop').classList.remove('show');
    document.getElementById('modulesPanel').classList.remove('show');
  },
  // Widget-specific logic
  async updateWeatherWidget(id) {
    const widget = this.widgets.find(w => w.id === id);
    if (!widget) return;
    const key = 'a45f91753c30a6f446059e09d0124b89';
    let lat = localStorage.getItem('kuppyWeatherLat');
    let lon = localStorage.getItem('kuppyWeatherLon');
    let city = localStorage.getItem('kuppyWeatherCity') || 'New York'; // Default city

    if (!lat || !lon) {
      try {
        const position = await new Promise((resolve, reject) => {
          navigator.geolocation.getCurrentPosition(resolve, reject);
        });
        lat = position.coords.latitude;
        lon = position.coords.longitude;
        localStorage.setItem('kuppyWeatherLat', lat);
        localStorage.setItem('kuppyWeatherLon', lon);
      } catch (e) {
        // Use default city if geolocation fails
      }
    }

    const url = lat && lon 
      ? `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&units=imperial&appid=${key}`
      : `https://api.openweathermap.org/data/2.5/weather?q=${city}&units=imperial&appid=${key}`;

    try {
      const response = await fetch(url);
      const data = await response.json();

      if (data.cod !== 200) throw new Error(data.message);

      document.getElementById(`widget-temp-${id}`).textContent = `${Math.round(data.main.temp)}¬∞F`;
      document.getElementById(`widget-city-${id}`).textContent = data.name;
      document.getElementById(`widget-feels-${id}`).textContent = `${Math.round(data.main.feels_like)}¬∞F`;
      document.getElementById(`widget-humidity-${id}`).textContent = `${data.main.humidity}%`;
      document.getElementById(`widget-wind-${id}`).textContent = `${Math.round(data.wind.speed)} mph`;
      document.getElementById(`widget-icon-${id}`).textContent = getWeatherIcon(data.weather[0].icon);

    } catch (error) {
      console.error('Widget Weather API error:', error);
      document.getElementById(`widget-temp-${id}`).textContent = '--¬∞F';
      document.getElementById(`widget-city-${id}`).textContent = 'Unavailable';
    }
  },
  initTimerWidget(widget) {
    if (!widget.data.schedule) {
      widget.data.schedule = JSON.parse(localStorage.getItem('kuppyClassSchedule') || '{}');
      this.saveWidgets();
    }
    const updateTimer = () => {
      const schedule = widget.data.schedule || {};
      const now = new Date();
      const day = now.getDay();
      const timeInMinutes = now.getHours() * 60 + now.getMinutes();

      // Find current or next block
      let currentBlock = null;
      let nextBlock = null;

      const blockTimes = Object.keys(schedule).map(key => {
        const timeStr = schedule[key];
        if (!timeStr) return null;
        const [hour, minute] = timeStr.split(':').map(Number);
        return { name: key, time: hour * 60 + minute };
      }).filter(b => b !== null).sort((a, b) => a.time - b.time);

      for (let i = 0; i < blockTimes.length; i++) {
        const block = blockTimes[i];
        const next = blockTimes[i + 1];

        if (timeInMinutes < block.time) {
          nextBlock = block;
          break;
        } else if (next && timeInMinutes >= block.time && timeInMinutes < next.time) {
          currentBlock = block;
          nextBlock = next;
          break;
        } else if (i === blockTimes.length - 1 && timeInMinutes >= block.time) {
          // Last block of the day, timer counts until midnight
          currentBlock = block;
          nextBlock = { name: 'End of Day', time: 24 * 60 };
          break;
        }
      }

      const displayEl = document.getElementById(`widget-timer-display-${widget.id}`);
      const messageEl = document.getElementById(`widget-timer-msg-${widget.id}`);
      if (!displayEl || !messageEl) return;

      if (currentBlock) {
        const remainingTime = nextBlock.time - timeInMinutes;
        const remainingMinutes = remainingTime;
        const displayMins = remainingMinutes % 60;
        const displayHrs = Math.floor(remainingMinutes / 60);

        messageEl.textContent = `Time left in ${currentBlock.name}:`;
        displayEl.textContent = `${displayHrs.toString().padStart(2, '0')}:${displayMins.toString().padStart(2, '0')}`;
      } else if (nextBlock) {
        const remainingTime = nextBlock.time - timeInMinutes;
        const remainingMinutes = remainingTime;
        const displayMins = remainingMinutes % 60;
        const displayHrs = Math.floor(remainingMinutes / 60);

        messageEl.textContent = `Next block (${nextBlock.name}) in:`;
        displayEl.textContent = `${displayHrs.toString().padStart(2, '0')}:${displayMins.toString().padStart(2, '0')}`;
      } else {
        messageEl.textContent = 'No schedule set for today.';
        displayEl.textContent = '--:--';
      }

      setTimeout(updateTimer, 1000);
    };
    updateTimer();
  },
  showTimerSettings(widget) {
    const backdrop = document.getElementById('modulesBackdrop');
    if (backdrop) backdrop.classList.add('show');

    const panel = document.createElement('div');
    panel.className = 'timer-settings-panel';
    panel.innerHTML = `
      <button class="timer-settings-close" id="timerSettingsClose">√ó</button>
      <h2>Class Schedule</h2>
      <p style="color: var(--muted); font-size: 13px; text-align: center; margin-bottom: 20px;">
        Set the *start time* for each class block (e.g., 8:00).
      </p>
      <div id="scheduleInputs">
        <label for="class-block1">Block 1 Start Time:</label>
        <input type="time" id="class-block1" value="${widget.data.schedule && widget.data.schedule['Block 1'] ? widget.data.schedule['Block 1'] : ''}" />

        <label for="class-block2">Block 2 Start Time:</label>
        <input type="time" id="class-block2" value="${widget.data.schedule && widget.data.schedule['Block 2'] ? widget.data.schedule['Block 2'] : ''}" />

        <label for="class-block3">Block 3 Start Time:</label>
        <input type="time" id="class-block3" value="${widget.data.schedule && widget.data.schedule['Block 3'] ? widget.data.schedule['Block 3'] : ''}" />

        <label for="class-block4">Block 4 Start Time:</label>
        <input type="time" id="class-block4" value="${widget.data.schedule && widget.data.schedule['Block 4'] ? widget.data.schedule['Block 4'] : ''}" />

        <label for="class-block5">Block 5 Start Time:</label>
        <input type="time" id="class-block5" value="${widget.data.schedule && widget.data.schedule['Block 5'] ? widget.data.schedule['Block 5'] : ''}" />

        <label for="class-block6">Block 6 Start Time:</label>
        <input type="time" id="class-block6" value="${widget.data.schedule && widget.data.schedule['Block 6'] ? widget.data.schedule['Block 6'] : ''}" />

        <label for="class-block7">Block 7 Start Time:</label>
        <input type="time" id="class-block7" value="${widget.data.schedule && widget.data.schedule['Block 7'] ? widget.data.schedule['Block 7'] : ''}" />

        <label for="class-block8">Block 8 Start Time:</label>
        <input type="time" id="class-block8" value="${widget.data.schedule && widget.data.schedule['Block 8'] ? widget.data.schedule['Block 8'] : ''}" />
      </div>

      <button class="btn timer-btn" id="saveTimerSettings" style="width: 100%; margin-top: 20px;">Save Schedule</button>
    `;

    document.body.appendChild(panel);

    document.getElementById('timerSettingsClose').onclick = () => {
      panel.remove();
      if (backdrop) backdrop.classList.remove('show');
    };

    document.getElementById('saveTimerSettings').onclick = () => {
      const schedule = {
        'Block 1': document.getElementById('class-block1').value,
        'Block 2': document.getElementById('class-block2').value,
        'Block 3': document.getElementById('class-block3').value,
        'Block 4': document.getElementById('class-block4').value,
        'Block 5': document.getElementById('class-block5').value,
        'Block 6': document.getElementById('class-block6').value,
        'Block 7': document.getElementById('class-block7').value,
        'Block 8': document.getElementById('class-block8').value,
      };

      widget.data.schedule = schedule;
      localStorage.setItem('kuppyClassSchedule', JSON.stringify(schedule));
      this.saveWidgets();

      // Refresh the widget
      const widgetEl = document.querySelector(`[data-widget-id="${widget.id}"]`);
      if (widgetEl) {
        widgetEl.remove();
        this.renderWidget(widget);
      }

      panel.remove();
      if (backdrop) backdrop.classList.remove('show');

      if (typeof showToast === 'function') {
        showToast('‚úÖ Class schedule saved!', 'success');
      }
    };
  }
};
ModulesSystem.init();

// Easter Egg
let clickCount = 0;
document.getElementById('typedTitle').addEventListener('click', () => {
  clickCount++;
  if (clickCount >= 7) {
    if (!KuppyState.stats.secretsFound) {
      KuppyState.stats.secretsFound = 1;
      saveStats();
      showToast('ü§´ Easter Egg Found!', 'success');
    } else {
      showToast('ü§´ You found the secret! Here\'s a surprise!', 'success');
    }
    const saved = JSON.parse(localStorage.getItem('customPresets') || '[]');
    const allGames = [...defaultGames, ...saved];
    const randomGame = allGames[Math.floor(Math.random() * allGames.length)];
    let starred = JSON.parse(localStorage.getItem('starredGames') || '[]');
    if (!starred.includes(randomGame.name)) {
      starred.push(randomGame.name);
      localStorage.setItem('starredGames', JSON.stringify(starred));
      showToast(`‚≠ê ${randomGame.name} has been auto-starred!`, 'success');
      displayStarredGames();
    }
    clickCount = 0;
  }
});


const cardObserver = new MutationObserver(() => {
  document.querySelectorAll('.card:not(.breathe-checked)').forEach(card => {
    card.classList.add('breathe-checked');
    card.addEventListener('mouseenter', () => {
      if (KuppyState.soundEnabled) {
        playSound(300, 0.05, 'sine');
      }
    });
  });
});

['allGamesGrid', 'multiGamesGrid', 'puzzleGamesGrid', 'obbyGamesGrid', 'sportsGamesGrid'].forEach(id => {
  const grid = document.getElementById(id);
  if (grid) {
    cardObserver.observe(grid, { childList: true, subtree: true });
  }
});

if (KuppyState.stats.launches > 0 && KuppyState.stats.launches % 10 === 0) {
  setTimeout(() => {
    createConfetti(window.innerWidth / 2, window.innerHeight / 2, 30);
    showToast(`üéâ Milestone! You've launched ${KuppyState.stats.launches} games!`, 'success');
  }, 3000);
}


// Event listeners for animations/interactions
document.addEventListener('click', (e) => {
  if (e.target.classList.contains('starBtn')) {
    const rect = e.target.getBoundingClientRect();
    createConfetti(rect.left + rect.width / 2, rect.top + rect.height / 2, 20);
    KuppyState.stats.favorites = JSON.parse(localStorage.getItem('starredGames') || '[]').length;
    saveStats();
  }
});

window.addEventListener('load', () => {
  document.body.classList.add('loaded');
  const welcomeOverlay = document.getElementById('welcomeOverlay');
  const welcomeProgress = document.getElementById('welcomeProgress');
  let progress = 0;
  const progressInterval = setInterval(() => {
    progress += Math.random() * 15 + 5;
    if (progress >= 100) progress = 100;
    welcomeProgress.style.width = progress + '%';
    if (progress >= 100) {
      clearInterval(progressInterval);
      setTimeout(() => {
        welcomeOverlay.classList.add('hide');
        setTimeout(() => {
          welcomeOverlay.remove();
        }, 1000);
      }, 500);
    }
  }, 150);
});

setInterval(() => {
  KuppyState.stats.playtime += 1;
  saveStats();
}, 1000);

document.querySelectorAll('.btn, button').forEach(btn => {
  btn.addEventListener('click', () => {
    if (KuppyState.soundEnabled) {
      playSound(440, 0.05, 'sine');
    }
  });
});
</script>
</body>
</html>
